<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amway Business Planner 2025 - Professional Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* Organization Chart Styles */
        .org-container {
            position: relative;
            background: white;
            border-radius: 12px;
            padding: 40px;
            overflow: auto;
            min-height: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .org-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            min-width: max-content;
            padding: 40px;
            cursor: grab;
        }
        
        .org-tree:active {
            cursor: grabbing;
        }
        
        .org-chart-viewport {
            overflow: auto;
            position: relative;
            width: 100%;
            height: 600px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        
        .org-node {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            z-index: 10;
            transition: all 0.3s ease;
            border: 4px solid white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .org-node:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(0,0,0,0.25);
        }
        
        .org-node.selected {
            border-color: #fbbf24;
            box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.3);
            transform: scale(1.05);
        }
        
        .org-node.vcs-non-compliant {
            border-color: #ef4444;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .org-node-controls {
            position: absolute;
            top: -15px;
            right: -5px;
            display: flex;
            gap: 5px;
            z-index: 20;
        }
        
        .org-node-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: white;
        }
        
        .org-node-btn.add {
            background: #10b981;
        }
        
        .org-node-btn.delete {
            background: #ef4444;
        }
        
        .org-node-btn.collapse {
            background: #6366f1;
        }
        
        .org-node-btn.collapse.collapsed {
            background: #f59e0b;
        }
        
        .org-node-btn.view-income {
            background: #10b981;
        }
        
        .org-node-btn.view-income.active {
            background: #fbbf24;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .org-node-btn:hover {
            transform: scale(1.15);
        }
        
        /* Qualification Level Badge */
        .qual-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 25;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .qual-badge.bww {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .qual-badge.silver {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            color: white;
        }
        
        .qual-badge.gold {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1f2937;
        }
        
        .qual-badge.platinum {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            color: #1f2937;
        }
        
        .qual-badge.ruby {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .qual-badge.sapphire {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        
        .qual-badge.emerald {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .qual-badge.diamond {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }
        
        /* Collapsed node indicator */
        .org-node.has-collapsed-children::after {
            content: '...';
            position: absolute;
            bottom: 5px;
            font-size: 16px;
            font-weight: bold;
            color: rgba(255,255,255,0.7);
        }
        
        /* Hierarchical Tree Styles - Pedigree Chart Format */
        .org-node-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .org-children {
            display: flex;
            flex-direction: row;
            justify-content: center;
            position: relative;
            margin-top: 50px;
        }
        
        .org-children > .org-node-wrapper {
            margin: 0 15px;
        }
        
        /* Vertical line from parent down to horizontal bar */
        .org-children::before {
            content: '';
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 25px;
            background: #94a3b8;
            z-index: 1;
        }
        
        /* Vertical line from horizontal bar down to each child */
        .org-children > .org-node-wrapper::before {
            content: '';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 25px;
            background: #94a3b8;
            z-index: 1;
        }
        
        /* Horizontal bar - will be set dynamically by JS */
        .org-children-bar {
            position: absolute;
            top: -25px;
            height: 3px;
            background: #94a3b8;
            z-index: 1;
        }
        
        /* Single child - extend the vertical line directly */
        .org-children.single-child::before {
            height: 50px;
        }
        
        .org-children.single-child > .org-node-wrapper::before {
            display: none;
        }
        
        /* Tab Styles */
        .tab-btn {
            position: relative;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 500;
        }
        
        .tab-btn.active {
            color: #4f46e5;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #4f46e5;
            border-radius: 3px 3px 0 0;
        }
        
        /* Income Cards */
        .income-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }
        
        .income-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: none;
            background: #4f46e5;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .zoom-btn:hover {
            background: #4338ca;
            transform: scale(1.05);
        }
        
        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            .no-print {
                display: none !important;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .org-node {
                width: 100px;
                height: 100px;
                font-size: 10px;
            }
            
            .org-node-wrapper {
                margin: 0 10px;
            }
        }
        
        /* Dark Mode Styles */
        .dark-mode {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #1f2937;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-color: #374151;
        }
        
        .dark-mode body,
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .dark-mode .bg-white {
            background-color: #1f2937 !important;
            color: #f3f4f6;
        }
        
        .dark-mode .bg-gray-50 {
            background-color: #374151 !important;
            color: #f3f4f6;
        }
        
        .dark-mode .bg-gray-100 {
            background-color: #4b5563 !important;
        }
        
        .dark-mode .text-gray-800,
        .dark-mode .text-gray-700,
        .dark-mode .text-gray-600 {
            color: #e5e7eb !important;
        }
        
        .dark-mode .text-gray-500,
        .dark-mode .text-gray-400 {
            color: #9ca3af !important;
        }
        
        .dark-mode .border-gray-200,
        .dark-mode .border-gray-300 {
            border-color: #4b5563 !important;
        }
        
        .dark-mode .border {
            border-color: #4b5563;
        }
        
        .dark-mode input,
        .dark-mode select {
            background-color: #374151 !important;
            color: #f3f4f6 !important;
            border-color: #4b5563 !important;
        }
        
        .dark-mode input::placeholder {
            color: #9ca3af !important;
        }
        
        .dark-mode .org-container {
            background: #1f2937;
        }
        
        .dark-mode .org-chart-viewport {
            background: #1f2937;
            border-color: #374151;
        }
        
        .dark-mode .modal-content {
            background: #1f2937;
            color: #f3f4f6;
        }
        
        .dark-mode .bg-yellow-50 {
            background-color: #422006 !important;
            border-color: #854d0e !important;
        }
        
        .dark-mode .text-yellow-800,
        .dark-mode .text-yellow-700 {
            color: #fef08a !important;
        }
        
        .dark-mode .bg-blue-50 {
            background-color: #1e3a5f !important;
        }
        
        .dark-mode .bg-green-50 {
            background-color: #14532d !important;
        }
        
        .dark-mode .bg-purple-50 {
            background-color: #3b0764 !important;
        }
        
        .dark-mode .bg-orange-50 {
            background-color: #431407 !important;
        }
        
        .dark-mode .bg-red-50 {
            background-color: #450a0a !important;
        }
        
        .dark-mode .bg-blue-100 {
            background-color: #1e40af !important;
        }
        
        .dark-mode .border-blue-300 {
            border-color: #3b82f6 !important;
        }
        
        .dark-mode .text-blue-800 {
            color: #93c5fd !important;
        }
        
        .dark-mode .shadow-lg,
        .dark-mode .shadow-sm {
            box-shadow: 0 10px 40px rgba(0,0,0,0.3) !important;
        }
        
        .dark-mode .tab-btn {
            color: #9ca3af;
        }
        
        .dark-mode .tab-btn.active {
            color: #818cf8;
        }
        
        .dark-mode .tab-btn.active::after {
            background: #818cf8;
        }
        
        /* Theme toggle button */
        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            background: #4b5563;
            color: white;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
        }
        
        .dark-mode .theme-toggle {
            background: #fbbf24;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-4 md:p-6"></div>

    <script>
        // ============================================
        // AMWAY BUSINESS PLANNER - MAIN APPLICATION
        // ============================================
        
        class AmwayBusinessPlanner {
            constructor() {
                // Application State
                this.state = {
                    organization: new Map(),
                    monthlyData: new Map(),
                    selectedNode: null,
                    incomePerspectiveNode: 'root', // Which IBO's income we're viewing
                    currentMonth: new Date().toISOString().slice(0, 7),
                    currentTab: 'visual',
                    zoomLevel: 1,
                    timelineStartIndex: 0,
                    timelineRange: 8,
                    darkMode: false,
                    panX: 0,
                    panY: 0,
                    isPanning: false,
                    panStartX: 0,
                    panStartY: 0,
                    collapsedNodes: new Set(),
                    savedVersions: [] // Array of saved versions with timestamps
                };
                
                // Chart instances for cleanup
                this.charts = {};
                
                // Configuration
                this.config = {
                    pvToBvRatio: 3.43,
                    performanceSchedule: [
                        { min: 7500, max: Infinity, rate: 25, label: 'Platinum+' },
                        { min: 6000, max: 7499, rate: 23, label: 'High Platinum' },
                        { min: 4000, max: 5999, rate: 21, label: 'Platinum Track' },
                        { min: 2500, max: 3999, rate: 18, label: 'Gold Producer' },
                        { min: 1500, max: 2499, rate: 15, label: 'Silver Producer' },
                        { min: 1000, max: 1499, rate: 12, label: 'Developing' },
                        { min: 600, max: 999, rate: 9, label: 'Building' },
                        { min: 300, max: 599, rate: 6, label: 'Growing' },
                        { min: 100, max: 299, rate: 3, label: 'Start' },
                        { min: 0, max: 99, rate: 0, label: 'New' }
                    ]
                };
                
                this.init();
            }
            
            // ============================================
            // INITIALIZATION
            // ============================================
            
            init() {
                // Initialize root node
                this.state.organization.set('root', {
                    id: 'root',
                    name: 'You',
                    pv: 150,
                    bv: 150 * this.config.pvToBvRatio,
                    customerSalesPV: 105, // 70% of 150
                    vcsPV: 90, // 60% of 150
                    vcsCompliant: true,
                    children: [],
                    parent: null,
                    level: 0,
                    registrationDate: new Date().toISOString(),
                    notes: '' // Member notes/comments
                });
                
                this.loadSavedData();
                this.loadThemePreference();
                this.render();
                this.attachGlobalEventListeners();
            }
            
            // ============================================
            // RENDERING
            // ============================================
            
            render() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <!-- Header -->
                        <header class="bg-white rounded-lg shadow-lg p-6 mb-6 fade-in">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                                        <i class="fas fa-project-diagram mr-3 text-indigo-600"></i>
                                        Amway Business Planner 2025
                                    </h1>
                                    <p class="text-gray-600">Professional Edition - Complete Business Modeling & Analytics</p>
                                </div>
                                <div class="flex gap-2 no-print flex-wrap items-center">
                                    <button onclick="app.toggleTheme()" class="theme-toggle" title="Toggle Dark Mode">
                                        <i class="fas ${this.state.darkMode ? 'fa-sun' : 'fa-moon'}"></i>
                                    </button>
                                    <button onclick="app.exportManager.exportToPDF()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                        <i class="fas fa-file-pdf mr-2"></i><span class="hidden sm:inline">Export </span>PDF
                                    </button>
                                    <button onclick="app.exportManager.exportToImage()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-image mr-2"></i><span class="hidden sm:inline">Export </span>Image
                                    </button>
                                    <button onclick="app.exportManager.exportToJSON()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors" title="Backup all data">
                                        <i class="fas fa-download mr-2"></i><span class="hidden sm:inline">Backup</span>
                                    </button>
                                    <button onclick="app.exportManager.triggerImport()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors" title="Restore from backup">
                                        <i class="fas fa-upload mr-2"></i><span class="hidden sm:inline">Restore</span>
                                    </button>
                                    <button onclick="app.showVersionManager()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors" title="Manage saved versions">
                                        <i class="fas fa-history mr-2"></i><span class="hidden sm:inline">Versions</span>
                                    </button>
                                    <button onclick="app.saveVersion()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors" title="Save current state as a version">
                                        <i class="fas fa-save mr-2"></i><span class="hidden sm:inline">Save Version</span>
                                    </button>
                                </div>
                                <!-- Hidden file input for import -->
                                <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="app.exportManager.importFromJSON(event)">
                            </div>
                        </header>
                        
                        <!-- Main Content -->
                        <div class="bg-white rounded-lg shadow-lg p-6 fade-in">
                            <!-- Tabs -->
                            <nav class="border-b border-gray-200 mb-6">
                                <div class="flex space-x-8 overflow-x-auto">
                                    <button class="tab-btn active" data-tab="visual" onclick="app.switchTab('visual')">
                                        <i class="fas fa-sitemap mr-2"></i><span class="hidden sm:inline">Visual </span>Builder
                                    </button>
                                    <button class="tab-btn" data-tab="multimonth" onclick="app.switchTab('multimonth')">
                                        <i class="fas fa-calendar-alt mr-2"></i><span class="hidden sm:inline">Multi-Month </span>Planning
                                    </button>
                                    <button class="tab-btn" data-tab="analytics" onclick="app.switchTab('analytics')">
                                        <i class="fas fa-chart-line mr-2"></i>Analytics
                                    </button>
                                    <button class="tab-btn" data-tab="incentives" onclick="app.switchTab('incentives')">
                                        <i class="fas fa-trophy mr-2"></i>Incentives
                                    </button>
                                </div>
                            </nav>
                            
                            <!-- Tab Content -->
                            <div id="tab-content"></div>
                        </div>
                        
                        <!-- Disclaimers -->
                        <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-6 mt-6 fade-in">
                            <h3 class="text-lg font-bold text-yellow-800 mb-3">
                                <i class="fas fa-exclamation-triangle mr-2"></i>Important Disclaimers
                            </h3>
                            <div class="text-sm text-yellow-700 space-y-2">
                                <p><strong>Income Disclosure:</strong> For the calendar year 2024, the average income from Amway for all U.S. registered IBOs at the Founders Platinum level and below was approximately $900 before expenses.</p>
                                <p><strong>Results Vary:</strong> Earnings depend on many factors, including customer base, business experience, effort, dedication, and quality and performance of the downline sales team.</p>
                                <p><strong>Baseline Requirements:</strong> IBOs must meet baseline requirements including average 150 Personal PV monthly, at least 60% from Verified Customer Sales, and adherence to Rules of Conduct.</p>
                                <p><strong>Calculator Notice:</strong> This calculator provides estimates based on 2025 compensation plan data and should be used for planning purposes only.</p>
                            </div>
                        </div>
                    </div>
                `;
                
                this.renderTabContent();
            }
            
            renderTabContent() {
                const content = document.getElementById('tab-content');
                
                switch(this.state.currentTab) {
                    case 'visual':
                        content.innerHTML = this.renderVisualBuilder();
                        this.renderOrganizationChart();
                        this.attachVisualBuilderEvents();
                        break;
                    case 'multimonth':
                        content.innerHTML = this.renderMultiMonth();
                        this.attachMultiMonthEvents();
                        break;
                    case 'analytics':
                        content.innerHTML = this.renderAnalytics();
                        setTimeout(() => this.initializeCharts(), 100);
                        break;
                    case 'incentives':
                        content.innerHTML = this.renderIncentives();
                        break;
                }
            }
            
            // ============================================
            // VISUAL BUILDER TAB
            // ============================================
            
            renderVisualBuilder() {
                return `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Organization Chart -->
                        <div class="lg:col-span-2">
                            <div class="mb-4 flex flex-wrap justify-between items-center gap-2">
                                <h3 class="text-xl font-bold text-gray-800">Organization Structure</h3>
                                <div class="flex flex-wrap items-center gap-2">
                                    <select id="example-selector" class="px-3 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-300" onchange="app.loadExampleStructure(this.value)">
                                        <option value="">ðŸ“Š Load Example...</option>
                                        <optgroup label="BWW SYR Levels (Below 7,500 PV)">
                                            <option value="bfi_t5">BFI-T5 (Team of 5, 750 PV)</option>
                                            <option value="bbi_t10">BBI-T10 (Team of 10, 1,500 PV)</option>
                                            <option value="bts25">BTS25 - Bronze to Silver (25 IBOs, 3,750 PV)</option>
                                            <option value="ep40">EP40 - Eagle Platinum (40 IBOs, 6,000 PV)</option>
                                        </optgroup>
                                        <optgroup label="Amway Producer Levels (7,500+ PV)">
                                            <option value="silver">Silver Producer (50 IBOs, 7,500 PV)</option>
                                            <option value="gold">Gold Producer (Silver Ã— 3 months)</option>
                                            <option value="platinum">Platinum (50 IBOs, 7,500 PV Ã— 6 months)</option>
                                            <option value="founders_platinum">Founders Platinum (7,500 PV Ã— 12 months)</option>
                                        </optgroup>
                                        <optgroup label="Amway Pin Levels">
                                            <option value="ruby">Ruby (100 IBOs, 15,000 PV - no leg at 25%)</option>
                                            <option value="sapphire">Sapphire (102 IBOs, 2 legs at 25%)</option>
                                            <option value="emerald">Emerald (153 IBOs, 3 legs at 25%)</option>
                                            <option value="diamond">Diamond (306 IBOs, 6 legs at 25%)</option>
                                        </optgroup>
                                        <optgroup label="Executive Levels (FP Groups)">
                                            <option value="executive_diamond">Executive Diamond (6 FP groups)</option>
                                            <option value="double_diamond">Double Diamond (8 FP groups)</option>
                                            <option value="triple_diamond">Triple Diamond (10 FP groups)</option>
                                            <option value="crown">Crown (12 FP groups)</option>
                                            <option value="crown_ambassador">Crown Ambassador (14 FP groups)</option>
                                            <option value="founders_crown_ambassador">Founders Crown Ambassador (14+ FP)</option>
                                        </optgroup>
                                    </select>
                                    <select id="month-selector" class="px-3 py-2 border rounded-lg text-sm" onchange="app.changeMonth(this.value)">
                                        ${this.generateMonthOptions()}
                                    </select>
                                    <button onclick="app.pushToMultiMonth()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                                        <i class="fas fa-calendar-plus mr-2"></i>Push to Multi-Month
                                    </button>
                                </div>
                            </div>
                            
                            <div class="org-container relative">
                                <div class="zoom-controls no-print">
                                    <button class="zoom-btn" onclick="app.zoomIn()" title="Zoom In">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="zoom-btn" onclick="app.zoomOut()" title="Zoom Out">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button class="zoom-btn" onclick="app.autoFit()" title="Auto Fit">
                                        <i class="fas fa-expand-arrows-alt"></i>
                                    </button>
                                    <button class="zoom-btn" onclick="app.resetPan()" title="Reset View">
                                        <i class="fas fa-home"></i>
                                    </button>
                                    <button class="zoom-btn" onclick="app.resetOrganization()" title="Reset Organization" style="background: #ef4444;">
                                        <i class="fas fa-trash-restore"></i>
                                    </button>
                                </div>
                                <div id="org-viewport" class="org-chart-viewport">
                                    <div id="org-chart" class="org-tree" style="transform: scale(${this.state.zoomLevel}) translate(${this.state.panX || 0}px, ${this.state.panY || 0}px); transform-origin: top center;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Member Details & Income Panel -->
                        <div class="space-y-6">
                            <!-- Member Details -->
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">
                                    <i class="fas fa-user-edit mr-2"></i>Member Details
                                </h3>
                                <form id="member-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                        <input type="text" id="member-name" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter name">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Monthly PV</label>
                                        <input type="number" id="member-pv" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" min="0" step="10">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Monthly BV (Auto-calculated)</label>
                                        <input type="number" id="member-bv" class="w-full px-3 py-2 border rounded-lg bg-gray-100" readonly>
                                        <p class="text-xs text-gray-500 mt-1">BV = PV Ã— 3.43</p>
                                    </div>
                                    
                                    <div class="border-t pt-4">
                                        <h4 class="font-semibold mb-3">VCS Compliance</h4>
                                        <div class="space-y-2">
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Customer Sales PV (70% required)</label>
                                                <input type="number" id="customer-sales-pv" class="w-full px-3 py-2 border rounded-lg text-sm" min="0">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 mb-1">Verified Customer Sales PV (60% required)</label>
                                                <input type="number" id="vcs-pv" class="w-full px-3 py-2 border rounded-lg text-sm" min="0">
                                            </div>
                                            <div id="vcs-status" class="text-xs"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="border-t pt-4">
                                        <h4 class="font-semibold mb-3"><i class="fas fa-sticky-note mr-2"></i>Notes & Comments</h4>
                                        <textarea id="member-notes" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" rows="3" placeholder="Add notes about this member (goals, follow-ups, etc.)"></textarea>
                                    </div>
                                    
                                    <div class="flex gap-2">
                                        <button type="button" onclick="app.saveMember()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                            <i class="fas fa-save mr-2"></i>Save
                                        </button>
                                        <button type="button" onclick="app.addDownline()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                        <button type="button" onclick="app.deleteMember(false)" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors" title="Delete (move children up)">
                                            <i class="fas fa-user-minus"></i>
                                        </button>
                                        <button type="button" onclick="app.deleteMember(true)" class="px-4 py-2 bg-red-800 text-white rounded-lg hover:bg-red-900 transition-colors" title="Delete with entire group">
                                            <i class="fas fa-users-slash"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Upgrade IBO to Structure Button -->
                                    <div class="border-t pt-4 mt-4">
                                        <button type="button" onclick="app.showUpgradeModal()" class="w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg">
                                            <i class="fas fa-level-up-alt mr-2"></i>Upgrade IBO to Structure
                                        </button>
                                        <p class="text-xs text-gray-500 mt-2 text-center">Replace this IBO with a complete business structure (e.g., Platinum, Diamond)</p>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Income Summary -->
                            <div class="income-card">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold">
                                        <i class="fas fa-dollar-sign mr-2"></i>Monthly Income
                                    </h3>
                                    <div id="income-perspective-indicator" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded"></div>
                                </div>
                                <div id="income-perspective-controls" class="hidden mb-3">
                                    <button onclick="app.resetIncomePerspective()" class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 py-2 rounded-lg transition-colors text-sm">
                                        <i class="fas fa-user mr-2"></i>Back to Your Income
                                    </button>
                                </div>
                                <div id="income-summary" class="space-y-2 text-sm"></div>
                                <div class="mt-4 pt-4 border-t border-white border-opacity-30">
                                    <div class="flex justify-between items-center">
                                        <span class="text-lg font-bold">Total:</span>
                                        <span id="total-income" class="text-2xl font-bold"></span>
                                    </div>
                                </div>
                                <button onclick="app.toggleIncomeDetails()" class="mt-4 w-full bg-white bg-opacity-20 hover:bg-opacity-30 py-2 rounded-lg transition-colors text-sm">
                                    <i class="fas fa-chevron-down mr-2"></i>View Detailed Breakdown
                                </button>
                            </div>
                            
                            <!-- Team Stats -->
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">Team Statistics</h3>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div class="text-center">
                                        <div id="total-members" class="text-2xl font-bold text-indigo-600">0</div>
                                        <div class="text-gray-600">Team Members</div>
                                    </div>
                                    <div class="text-center">
                                        <div id="total-pv" class="text-2xl font-bold text-green-600">0</div>
                                        <div class="text-gray-600">Total PV</div>
                                    </div>
                                    <div class="text-center">
                                        <div id="vcs-compliant" class="text-2xl font-bold text-blue-600">0</div>
                                        <div class="text-gray-600">VCS Compliant</div>
                                    </div>
                                    <div class="text-center">
                                        <div id="performance-level" class="text-2xl font-bold text-purple-600">0%</div>
                                        <div class="text-gray-600">Performance Level</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Income Details Modal -->
                    <div id="income-details-modal" class="modal">
                        <div class="modal-content">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-2xl font-bold text-gray-800">Detailed Income Breakdown</h3>
                                <button onclick="app.toggleIncomeDetails()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                            <div id="income-details-content"></div>
                        </div>
                    </div>
                    
                    <!-- Upgrade IBO Modal -->
                    <div id="upgrade-ibo-modal" class="modal">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-2xl font-bold text-gray-800">
                                    <i class="fas fa-level-up-alt mr-2 text-purple-600"></i>Upgrade IBO to Structure
                                </h3>
                                <button onclick="app.hideUpgradeModal()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    This will replace <strong id="upgrade-ibo-name">the selected IBO</strong> with a complete business structure. 
                                    Their existing downline will be preserved and added to the new structure.
                                </p>
                            </div>
                            <div class="space-y-4">
                                <label class="block text-sm font-medium text-gray-700">Select Structure to Apply:</label>
                                <select id="upgrade-structure-select" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-lg">
                                    <optgroup label="BWW SYR Levels (Below 7,500 PV)">
                                        <option value="bfi_t5">BFI-T5 (5 IBOs, 750 PV)</option>
                                        <option value="bbi_t10">BBI-T10 (10 IBOs, 1,500 PV)</option>
                                        <option value="bts25">BTS25 - Bronze to Silver (25 IBOs, 3,750 PV)</option>
                                        <option value="ep40">EP40 - Eagle Platinum (40 IBOs, 6,000 PV)</option>
                                    </optgroup>
                                    <optgroup label="Amway Producer Levels (7,500+ PV)">
                                        <option value="silver">Silver Producer (50 IBOs, 7,500 PV)</option>
                                        <option value="gold">Gold Producer (50 IBOs, 7,500 PV for 3mo)</option>
                                        <option value="platinum">Platinum (50 IBOs, 7,500 PV for 6mo)</option>
                                        <option value="founders_platinum">Founders Platinum (50 IBOs, 7,500 PV for 12mo)</option>
                                    </optgroup>
                                    <optgroup label="Amway Pin Levels">
                                        <option value="ruby">Ruby (100 IBOs, 15,000 PV - no leg at 25%)</option>
                                        <option value="sapphire">Sapphire (102 IBOs, 2 legs at 25%)</option>
                                        <option value="emerald">Emerald (153 IBOs, 3 legs at 25%)</option>
                                        <option value="diamond">Diamond (306 IBOs, 6 legs at 25%)</option>
                                    </optgroup>
                                    <optgroup label="Executive Levels">
                                        <option value="executive_diamond">Executive Diamond (6 FP groups)</option>
                                        <option value="double_diamond">Double Diamond (8 FP groups)</option>
                                        <option value="triple_diamond">Triple Diamond (10 FP groups)</option>
                                        <option value="crown">Crown (12 FP groups)</option>
                                        <option value="crown_ambassador">Crown Ambassador (14 FP groups)</option>
                                    </optgroup>
                                </select>
                                <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i>BWW levels (BFI, BBI, BTS, EP) only apply below Silver (7,500 PV)</p>
                                
                                <div class="flex items-center mt-4">
                                    <input type="checkbox" id="upgrade-keep-name" class="mr-2 w-5 h-5 text-purple-600" checked>
                                    <label for="upgrade-keep-name" class="text-sm text-gray-700">Keep original IBO name as the new structure's root</label>
                                </div>
                                
                                <div class="flex gap-3 mt-6">
                                    <button onclick="app.applyUpgrade()" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg font-semibold">
                                        <i class="fas fa-magic mr-2"></i>Apply Structure
                                    </button>
                                    <button onclick="app.hideUpgradeModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderOrganizationChart() {
                const container = document.getElementById('org-chart');
                if (!container) return;
                
                container.innerHTML = '';
                container.style.transform = `scale(${this.state.zoomLevel})`;
                container.style.transformOrigin = 'top center';
                
                // Render tree hierarchically starting from root
                const root = this.state.organization.get('root');
                if (root) {
                    const rootElement = this.createNodeElement(root);
                    container.appendChild(rootElement);
                }
                
                // Position horizontal bars after render completes
                requestAnimationFrame(() => {
                    this.positionConnectionBars();
                    this.attachPanningEvents();
                });
                
                this.updateIncomeSummary();
                this.updateTeamStats();
            }
            
            positionConnectionBars() {
                // Use setTimeout to ensure DOM is fully rendered
                setTimeout(() => {
                    const zoomLevel = this.state.zoomLevel || 1;
                    const childrenContainers = document.querySelectorAll('.org-children:not(.single-child)');
                    childrenContainers.forEach(container => {
                        // Find or create the bar
                        let bar = container.querySelector('.org-children-bar');
                        if (!bar) {
                            bar = document.createElement('div');
                            bar.className = 'org-children-bar';
                            container.appendChild(bar);
                        }
                        
                        const wrappers = container.querySelectorAll(':scope > .org-node-wrapper');
                        if (wrappers.length >= 2) {
                            const firstWrapper = wrappers[0];
                            const lastWrapper = wrappers[wrappers.length - 1];
                            
                            // Get the node circles inside wrappers
                            const firstNode = firstWrapper.querySelector('.org-node');
                            const lastNode = lastWrapper.querySelector('.org-node');
                            
                            if (firstNode && lastNode) {
                                const containerRect = container.getBoundingClientRect();
                                const firstRect = firstNode.getBoundingClientRect();
                                const lastRect = lastNode.getBoundingClientRect();
                                
                                // Adjust for zoom scale - getBoundingClientRect returns scaled values
                                // so we need to divide by zoom to get unscaled positions
                                const firstCenter = (firstRect.left + firstRect.width / 2 - containerRect.left) / zoomLevel;
                                const lastCenter = (lastRect.left + lastRect.width / 2 - containerRect.left) / zoomLevel;
                                
                                bar.style.left = firstCenter + 'px';
                                bar.style.width = Math.max(0, lastCenter - firstCenter) + 'px';
                                bar.style.display = 'block'; // Ensure bar is visible
                            }
                        }
                    });
                }, 50);
            }
            
            createNodeElement(node) {
                const wrapper = document.createElement('div');
                wrapper.className = 'org-node-wrapper';
                wrapper.dataset.nodeId = node.id;
                
                const vcsStatus = this.checkVCSCompliance(node);
                const personalPerformanceLevel = this.getPerformanceLevel(node.pv);
                const hasNotes = node.notes && node.notes.trim().length > 0;
                
                // Calculate this node's GROUP PV (including all downline)
                const groupPV = this.calculateGroupPV(node.id);
                const qualLevel = this.getQualificationLevel(groupPV, node.id);
                
                // Check if node is collapsed
                const isCollapsed = this.state.collapsedNodes && this.state.collapsedNodes.has(node.id);
                const hasChildren = node.children && node.children.length > 0;
                
                const nodeDiv = document.createElement('div');
                nodeDiv.className = `org-node ${this.state.selectedNode === node.id ? 'selected' : ''} ${!vcsStatus.compliant ? 'vcs-non-compliant' : ''} ${isCollapsed && hasChildren ? 'has-collapsed-children' : ''}`;
                nodeDiv.style.position = 'relative';
                
                // Add qualification badge if they qualify for something
                let badgeHtml = '';
                if (qualLevel.level !== 'IBO') {
                    badgeHtml = `<div class="qual-badge ${qualLevel.badgeClass}">${qualLevel.level}</div>`;
                }
                
                nodeDiv.innerHTML = `
                    ${badgeHtml}
                    <div class="text-xs font-bold mb-1">${node.name} ${hasNotes ? '<i class="fas fa-sticky-note text-yellow-500" title="Has notes"></i>' : ''}</div>
                    <div class="text-lg font-bold">${personalPerformanceLevel}%</div>
                    <div class="text-xs mt-1">${node.pv} PV</div>
                    <div class="text-xs opacity-75">${groupPV.toFixed(0)} GPV</div>
                    <div class="text-xs mt-1">${vcsStatus.compliant ? 'âœ“' : 'âš '} VCS</div>
                `;
                
                nodeDiv.onclick = () => this.selectNode(node.id);
                wrapper.appendChild(nodeDiv);
                
                // Add delete button to top-right corner of circle
                if (node.id !== 'root') {
                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'org-node-btn delete';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.top = '-10px';
                    deleteBtn.style.right = '-10px';
                    deleteBtn.style.zIndex = '30';
                    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.deleteMember(true, node.id);
                    };
                    nodeDiv.appendChild(deleteBtn);
                }
                
                // Add collapse/expand button to bottom-left corner if node has children
                if (hasChildren) {
                    const collapseBtn = document.createElement('div');
                    collapseBtn.className = `org-node-btn collapse ${isCollapsed ? 'collapsed' : ''}`;
                    collapseBtn.style.position = 'absolute';
                    collapseBtn.style.bottom = '-10px';
                    collapseBtn.style.left = '-10px';
                    collapseBtn.style.zIndex = '30';
                    collapseBtn.innerHTML = isCollapsed ? '<i class="fas fa-plus"></i>' : '<i class="fas fa-minus"></i>';
                    collapseBtn.title = isCollapsed ? 'Expand downline' : 'Collapse downline';
                    collapseBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.toggleNodeCollapse(node.id);
                    };
                    nodeDiv.appendChild(collapseBtn);
                }
                
                // Add "View Income" button to top-left corner
                const viewIncomeBtn = document.createElement('div');
                viewIncomeBtn.className = 'org-node-btn view-income';
                viewIncomeBtn.style.position = 'absolute';
                viewIncomeBtn.style.top = '-10px';
                viewIncomeBtn.style.left = '-10px';
                viewIncomeBtn.style.zIndex = '30';
                viewIncomeBtn.style.background = this.state.incomePerspectiveNode === node.id ? '#fbbf24' : '#10b981';
                viewIncomeBtn.innerHTML = '<i class="fas fa-dollar-sign"></i>';
                viewIncomeBtn.title = this.state.incomePerspectiveNode === node.id ? 'Currently viewing this income' : `View ${node.name}'s income`;
                viewIncomeBtn.onclick = (e) => {
                    e.stopPropagation();
                    this.setIncomePerspective(node.id);
                };
                nodeDiv.appendChild(viewIncomeBtn);
                
                // Add button to bottom-right corner of circle
                const addBtn = document.createElement('div');
                addBtn.className = 'org-node-btn add';
                addBtn.style.position = 'absolute';
                addBtn.style.bottom = '-10px';
                addBtn.style.right = '-10px';
                addBtn.style.zIndex = '30';
                addBtn.innerHTML = '<i class="fas fa-plus"></i>';
                addBtn.onclick = (e) => {
                    e.stopPropagation();
                    this.addDownlineToNode(node.id);
                };
                nodeDiv.appendChild(addBtn);
                
                wrapper.appendChild(nodeDiv);
                
                // Render children hierarchically below this node (only if not collapsed)
                if (hasChildren && !isCollapsed) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'org-children';
                    
                    // Add single-child class if only one child
                    if (node.children.length === 1) {
                        childrenContainer.classList.add('single-child');
                    }
                    
                    node.children.forEach(childId => {
                        const child = this.state.organization.get(childId);
                        if (child) {
                            const childElement = this.createNodeElement(child);
                            childrenContainer.appendChild(childElement);
                        }
                    });
                    
                    // Add horizontal bar placeholder for multiple children (positioned by positionConnectionBars)
                    if (node.children.length > 1) {
                        const bar = document.createElement('div');
                        bar.className = 'org-children-bar';
                        childrenContainer.appendChild(bar);
                    }
                    
                    wrapper.appendChild(childrenContainer);
                }
                
                return wrapper;
            }
            
            // Get qualification level for a group based on their structure
            getQualificationLevel(groupPV, nodeId = null) {
                // BWW SYR Levels (only apply below Silver 7500 PV)
                if (groupPV < 7500) {
                    if (groupPV >= 6000) return { level: 'EP40', badgeClass: 'bww' };
                    if (groupPV >= 3750) return { level: 'BTS25', badgeClass: 'bww' };
                    if (groupPV >= 1500) return { level: 'BBI', badgeClass: 'bww' };
                    if (groupPV >= 750) return { level: 'BFI', badgeClass: 'bww' };
                    return { level: 'IBO', badgeClass: '' };
                }
                
                // For Amway pins, we need to count qualified legs (legs at 7,500+ PV)
                // If no nodeId provided, just show Platinum for 7500+ PV
                if (!nodeId) {
                    if (groupPV >= 15000) return { level: 'Ruby', badgeClass: 'ruby' };
                    return { level: 'Platinum', badgeClass: 'platinum' };
                }
                
                // Count qualified legs (each leg at 7,500+ PV)
                const node = this.state.organization.get(nodeId);
                if (!node || !node.children || node.children.length === 0) {
                    // No legs - check for Ruby (15,000+ PV with no qualified legs)
                    if (groupPV >= 15000) return { level: 'Ruby', badgeClass: 'ruby' };
                    return { level: 'Platinum', badgeClass: 'platinum' };
                }
                
                // Count how many legs are at 25% level (7,500+ PV)
                let qualifiedLegs = 0;
                node.children.forEach(childId => {
                    const legPV = this.calculateGroupPV(childId);
                    if (legPV >= 7500) {
                        qualifiedLegs++;
                    }
                });
                
                // Amway Pin Levels based on qualified legs
                // Crown Ambassador: 14+ qualified legs
                if (qualifiedLegs >= 14) return { level: 'Crown Amb', badgeClass: 'diamond' };
                // Crown: 12+ qualified legs
                if (qualifiedLegs >= 12) return { level: 'Crown', badgeClass: 'diamond' };
                // Triple Diamond: 10+ qualified legs
                if (qualifiedLegs >= 10) return { level: 'Triple Dia', badgeClass: 'diamond' };
                // Double Diamond: 8+ qualified legs
                if (qualifiedLegs >= 8) return { level: 'Double Dia', badgeClass: 'diamond' };
                // Executive Diamond: 6+ qualified legs (Founders Platinum)
                if (qualifiedLegs >= 6) return { level: 'Diamond', badgeClass: 'diamond' };
                // Emerald: 3+ qualified legs
                if (qualifiedLegs >= 3) return { level: 'Emerald', badgeClass: 'emerald' };
                // Sapphire: 2+ qualified legs
                if (qualifiedLegs >= 2) return { level: 'Sapphire', badgeClass: 'sapphire' };
                
                // Ruby: 15,000+ PV with NO qualified legs (all legs under 7,500 PV)
                if (groupPV >= 15000 && qualifiedLegs === 0) return { level: 'Ruby', badgeClass: 'ruby' };
                
                // Platinum: 7,500+ PV (or 1 qualified leg)
                if (groupPV >= 7500) return { level: 'Platinum', badgeClass: 'platinum' };
                
                return { level: 'IBO', badgeClass: '' };
            }
            
            // Toggle collapse/expand for a node
            toggleNodeCollapse(nodeId) {
                if (!this.state.collapsedNodes) {
                    this.state.collapsedNodes = new Set();
                }
                
                if (this.state.collapsedNodes.has(nodeId)) {
                    this.state.collapsedNodes.delete(nodeId);
                } else {
                    this.state.collapsedNodes.add(nodeId);
                }
                
                this.renderOrganizationChart();
            }
            
            // Keep organizeByLevels for other uses (like stats)
            organizeByLevels() {
                const levels = new Map();
                
                const traverse = (nodeId, level) => {
                    const node = this.state.organization.get(nodeId);
                    if (!node) return;
                    
                    if (!levels.has(level)) {
                        levels.set(level, []);
                    }
                    levels.get(level).push(node);
                    
                    if (node.children) {
                        node.children.forEach(childId => {
                            traverse(childId, level + 1);
                        });
                    }
                };
                
                traverse('root', 0);
                return levels;
            }
            
            // ============================================
            // MULTI-MONTH PLANNING TAB
            // ============================================
            
            renderMultiMonth() {
                const monthsWithData = Array.from(this.state.monthlyData.entries())
                    .sort((a, b) => new Date(a[0]) - new Date(b[0]));
                
                const totalPeriodIncome = monthsWithData.reduce((sum, [_, data]) => sum + data.income.total, 0);
                const avgMonthlyIncome = monthsWithData.length > 0 ? totalPeriodIncome / monthsWithData.length : 0;
                
                const periodLabel = monthsWithData.length >= 12 
                    ? 'Yearly Income' 
                    : `Total Projected Income for ${monthsWithData.length} month${monthsWithData.length !== 1 ? 's' : ''}`;
                
                return `
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Multi-Month Business Planning</h3>
                        
                        ${monthsWithData.length > 0 ? `
                            <!-- Period Summary -->
                            <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg p-8 mb-6 text-center">
                                <div class="text-lg opacity-90 mb-2">${periodLabel}</div>
                                <div class="text-5xl font-bold mb-3">$${totalPeriodIncome.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                <div class="text-sm opacity-80">Average Monthly: $${avgMonthlyIncome.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            </div>
                            
                            <!-- Timeline Overview -->
                            <div class="bg-white border rounded-lg p-4 mb-6">
                                <h4 class="font-semibold mb-3">Timeline Overview</h4>
                                <div class="flex overflow-x-auto space-x-2 pb-2">
                                    ${monthsWithData.map(([month, data]) => `
                                        <div class="flex-shrink-0 bg-blue-100 rounded-lg px-4 py-3 text-sm border-2 border-blue-300">
                                            <div class="font-semibold text-blue-800">${this.formatMonthShort(month)}</div>
                                            <div class="text-xs text-gray-600 mt-1">${Math.round(data.income.totalPV)} PV</div>
                                            <div class="text-xs font-semibold text-green-600">$${data.income.total.toFixed(0)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Monthly Details -->
                            <div class="space-y-6">
                                ${monthsWithData.map(([month, data]) => `
                                    <div class="border-2 border-gray-200 rounded-lg p-6 bg-white shadow-sm hover:shadow-md transition-shadow">
                                        <div class="flex justify-between items-center mb-4">
                                            <h4 class="text-xl font-bold text-blue-600">${this.formatMonth(month)}</h4>
                                            <div class="flex items-center gap-4">
                                                <div class="text-right">
                                                    <div class="text-sm text-gray-600">Total PV: ${Math.round(data.income.totalPV)}</div>
                                                    <div class="text-lg font-bold text-green-600">$${data.income.total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                                </div>
                                                <button onclick="app.deleteMonthlyData('${month}')" class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors" title="Delete this month's data">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Mini Organization Chart -->
                                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                            <h5 class="font-semibold mb-3 text-sm text-gray-700">Organization Structure</h5>
                                            <div class="space-y-2">
                                                ${this.renderMiniOrgChart(data.organization)}
                                            </div>
                                        </div>
                                        
                                        <!-- Income Breakdown -->
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            <div class="bg-blue-50 rounded-lg p-3 text-center">
                                                <div class="text-xs text-gray-600 mb-1">Performance</div>
                                                <div class="font-bold text-blue-600">$${data.income.performanceBonus.toFixed(0)}</div>
                                            </div>
                                            <div class="bg-green-50 rounded-lg p-3 text-center">
                                                <div class="text-xs text-gray-600 mb-1">Differential</div>
                                                <div class="font-bold text-green-600">$${data.income.differentialBonus.toFixed(0)}</div>
                                            </div>
                                            <div class="bg-purple-50 rounded-lg p-3 text-center">
                                                <div class="text-xs text-gray-600 mb-1">Retail</div>
                                                <div class="font-bold text-purple-600">$${data.income.retailMargin.toFixed(0)}</div>
                                            </div>
                                            <div class="bg-orange-50 rounded-lg p-3 text-center">
                                                <div class="text-xs text-gray-600 mb-1">Customer Sales</div>
                                                <div class="font-bold text-orange-600">$${data.income.customerSalesIncentive.toFixed(0)}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-16">
                                <i class="fas fa-calendar-plus text-6xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500 text-lg mb-2">No monthly data yet</p>
                                <p class="text-gray-400 text-sm">Push your current business structure from the Visual Builder tab</p>
                            </div>
                        `}
                    </div>
                `;
            }
            
            renderMiniOrgChart(organization) {
                const root = organization.get('root');
                if (!root) return '<p class="text-gray-400 text-sm">No data</p>';
                
                const renderNode = (node, level = 0) => {
                    const indent = level * 20;
                    const vcsStatus = this.checkVCSCompliance(node);
                    const performanceLevel = this.getPerformanceLevel(node.pv);
                    
                    let html = `
                        <div class="flex items-center" style="margin-left: ${indent}px">
                            <div class="flex items-center space-x-2 bg-white rounded-full px-3 py-2 shadow-sm border ${vcsStatus.compliant ? 'border-green-200' : 'border-red-200'}">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-indigo-400 to-purple-500 flex items-center justify-center text-white text-xs font-bold">
                                    ${performanceLevel}%
                                </div>
                                <div>
                                    <div class="text-xs font-medium">${node.name}</div>
                                    <div class="text-xs text-gray-500">${node.pv} PV</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (node.children && node.children.length > 0) {
                        node.children.forEach(childId => {
                            const child = organization.get(childId);
                            if (child) {
                                html += renderNode(child, level + 1);
                            }
                        });
                    }
                    
                    return html;
                };
                
                return renderNode(root);
            }
            
            // ============================================
            // ANALYTICS TAB
            // ============================================
            
            renderAnalytics() {
                return `
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Performance Analytics</h3>
                        
                        ${this.state.monthlyData.size > 0 ? `
                            <!-- Timeline Controls -->
                            <div class="bg-white border rounded-lg p-4 mb-6">
                                <div class="flex justify-between items-center">
                                    <h4 class="font-semibold">Timeline View</h4>
                                    <div class="flex items-center space-x-4">
                                        <button onclick="app.scrollTimeline('left')" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-full transition-colors" ${this.state.timelineStartIndex === 0 ? 'disabled' : ''}>
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="text-sm text-gray-600">
                                            ${this.getVisibleMonthsLabel()}
                                        </span>
                                        <button onclick="app.scrollTimeline('right')" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-full transition-colors">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <select id="timeline-range" onchange="app.updateTimelineRange(this.value)" class="px-3 py-2 border rounded">
                                            <option value="6">6 Months</option>
                                            <option value="8" selected>8 Months</option>
                                            <option value="12">12 Months</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Charts -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white border rounded-lg p-6">
                                    <h4 class="font-semibold mb-4">Performance Timeline</h4>
                                    <canvas id="performance-chart" style="height: 300px;"></canvas>
                                </div>
                                <div class="bg-white border rounded-lg p-6">
                                    <h4 class="font-semibold mb-4">Income Distribution</h4>
                                    <canvas id="income-distribution-chart" style="height: 300px;"></canvas>
                                </div>
                                <div class="bg-white border rounded-lg p-6">
                                    <h4 class="font-semibold mb-4">Team Growth</h4>
                                    <canvas id="team-growth-chart" style="height: 300px;"></canvas>
                                </div>
                                <div class="bg-white border rounded-lg p-6">
                                    <h4 class="font-semibold mb-4">VCS Compliance Rate</h4>
                                    <canvas id="vcs-compliance-chart" style="height: 300px;"></canvas>
                                </div>
                            </div>
                        ` : `
                            <div class="text-center py-16">
                                <i class="fas fa-chart-line text-6xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500 text-lg mb-2">No analytics data yet</p>
                                <p class="text-gray-400 text-sm">Add monthly data to see performance analytics</p>
                            </div>
                        `}
                    </div>
                `;
            }
            
            initializeCharts() {
                if (this.state.monthlyData.size === 0) return;
                
                // Destroy existing chart instances to prevent memory leaks
                Object.values(this.charts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
                this.charts = {};
                
                const visibleMonths = this.getVisibleMonths();
                const monthLabels = visibleMonths.map(m => this.formatMonthShort(m));
                
                // Performance Timeline Chart
                const perfCtx = document.getElementById('performance-chart');
                if (perfCtx) {
                    const incomeData = visibleMonths.map(month => {
                        const data = this.state.monthlyData.get(month);
                        return data ? data.income.total : 0;
                    });
                    
                    const pvData = visibleMonths.map(month => {
                        const data = this.state.monthlyData.get(month);
                        return data ? data.income.totalPV : 0;
                    });
                    
                    this.charts.performance = new Chart(perfCtx, {
                        type: 'line',
                        data: {
                            labels: monthLabels,
                            datasets: [
                                {
                                    label: 'Monthly Income ($)',
                                    data: incomeData,
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    yAxisID: 'y',
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: 'Group PV',
                                    data: pvData,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    yAxisID: 'y1',
                                    tension: 0.4,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: 'Income ($)' }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: { display: true, text: 'PV' },
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });
                }
                
                // Income Distribution Chart
                const incomeDistCtx = document.getElementById('income-distribution-chart');
                if (incomeDistCtx && visibleMonths.length > 0) {
                    const latestMonth = visibleMonths[visibleMonths.length - 1];
                    const latestData = this.state.monthlyData.get(latestMonth);
                    
                    if (latestData) {
                        this.charts.incomeDistribution = new Chart(incomeDistCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Performance Bonus', 'Differential Bonus', 'Retail Margin', 'Customer Sales'],
                                datasets: [{
                                    data: [
                                        latestData.income.performanceBonus,
                                        latestData.income.differentialBonus,
                                        latestData.income.retailMargin,
                                        latestData.income.customerSalesIncentive
                                    ],
                                    backgroundColor: [
                                        'rgba(59, 130, 246, 0.8)',
                                        'rgba(16, 185, 129, 0.8)',
                                        'rgba(168, 85, 247, 0.8)',
                                        'rgba(245, 158, 11, 0.8)'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom' }
                                }
                            }
                        });
                    }
                }
                
                // Team Growth Chart
                const teamCtx = document.getElementById('team-growth-chart');
                if (teamCtx) {
                    const teamData = visibleMonths.map(month => {
                        const data = this.state.monthlyData.get(month);
                        return data ? data.organization.size - 1 : 0;
                    });
                    
                    this.charts.teamGrowth = new Chart(teamCtx, {
                        type: 'bar',
                        data: {
                            labels: monthLabels,
                            datasets: [{
                                label: 'Team Members',
                                data: teamData,
                                backgroundColor: 'rgba(168, 85, 247, 0.8)',
                                borderColor: 'rgba(168, 85, 247, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
                
                // VCS Compliance Chart
                const vcsCtx = document.getElementById('vcs-compliance-chart');
                if (vcsCtx) {
                    const vcsData = visibleMonths.map(month => {
                        const data = this.state.monthlyData.get(month);
                        if (!data) return 0;
                        
                        let compliant = 0;
                        data.organization.forEach(node => {
                            if (this.checkVCSCompliance(node).compliant) compliant++;
                        });
                        
                        return (compliant / data.organization.size) * 100;
                    });
                    
                    this.charts.vcsCompliance = new Chart(vcsCtx, {
                        type: 'line',
                        data: {
                            labels: monthLabels,
                            datasets: [{
                                label: 'VCS Compliance Rate (%)',
                                data: vcsData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // ============================================
            // INCENTIVES TAB
            // ============================================
            
            renderIncentives() {
                const incentives = this.calculateAllIncentives();
                const annualProj = this.calculateAnnualProjections();
                const faaProj = this.calculateFAAProjections();
                
                return `
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Auto-Calculated Incentives & Bonuses</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${incentives.breakdown.map(incentive => `
                                <div class="border-2 ${incentive.qualified ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-gray-50'} rounded-lg p-6">
                                    <div class="flex justify-between items-start mb-3">
                                        <h4 class="font-bold text-lg ${incentive.qualified ? 'text-green-700' : 'text-gray-500'}">${incentive.name}</h4>
                                        <i class="fas fa-${incentive.qualified ? 'check-circle text-green-500' : 'times-circle text-gray-400'} text-xl"></i>
                                    </div>
                                    <div class="text-3xl font-bold ${incentive.qualified ? 'text-green-600' : 'text-gray-400'} mb-2">

                                        $${incentive.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                    </div>
                                    <p class="text-sm ${incentive.qualified ? 'text-green-600' : 'text-gray-500'}">${incentive.description}</p>
                                    ${incentive.details ? `
                                        <div class="mt-3 pt-3 border-t ${incentive.qualified ? 'border-green-200' : 'border-gray-200'}">
                                            <div class="text-xs space-y-1">
                                                ${Object.entries(incentive.details).map(([key, value]) => `
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">${this.formatKey(key)}:</span>
                                                        <span class="font-medium">${value}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Total Incentives Summary -->
                        <div class="mt-8 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-lg p-8 text-center">
                            <h4 class="text-xl font-semibold mb-3">Total Monthly Incentives</h4>
                            <div class="text-5xl font-bold">$${incentives.total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <p class="text-sm opacity-90 mt-2">${incentives.breakdown.filter(i => i.qualified).length} of ${incentives.breakdown.length} incentives qualified</p>
                        </div>
                        
                        <!-- Annual Global Award Recognition (GAR) Projection -->
                        <div class="mt-8 border-t pt-6">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4">
                                <i class="fas fa-crown text-yellow-500 mr-2"></i>Annual Business Projection (GAR)
                            </h3>
                            <div class="bg-gradient-to-r from-purple-900 to-indigo-900 text-white rounded-lg p-6 shadow-xl">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <div>
                                        <div class="text-sm text-purple-200 uppercase tracking-wide font-semibold">Projected Pin Level</div>
                                        <div class="text-4xl font-bold my-2">${annualProj.level}</div>
                                        <div class="text-sm opacity-80">
                                            Based on ${this.countQualifiedLegs('root')} Qualified Legs & Depth Structure
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-purple-200">Qualification Credits (QC)</div>
                                        <div class="text-3xl font-bold">${annualProj.totalQC.toFixed(1)}</div>
                                        <div class="text-xs text-purple-300">
                                            Cap Applied: ${annualProj.details.capApplied || 'N/A'} per leg
                                        </div>
                                    </div>
                                </div>
                                
                                ${annualProj.annualBonus > 0 ? `
                                <div class="mt-6 pt-6 border-t border-purple-700 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <div>
                                        <span class="text-yellow-400 font-bold text-xl">
                                            <i class="fas fa-trophy mr-2"></i>Annual Cash Award
                                        </span>
                                        <span class="text-xs block text-purple-300">(Two-Time Cash Incentive Estimate)</span>
                                    </div>
                                    <div class="text-3xl font-bold text-yellow-400">
                                        $${annualProj.annualBonus.toLocaleString()}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <div class="mt-4 bg-black bg-opacity-20 rounded p-3 text-xs">
                                    <div class="font-bold mb-2 text-purple-200">Leg Depth Analysis:</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${annualProj.legData && annualProj.legData.length > 0 ? annualProj.legData.map((pts, idx) => `
                                            <div class="px-2 py-1 rounded ${pts >= (annualProj.details.capApplied || 12) ? 'bg-red-500 text-white' : 'bg-purple-800'}">
                                                Leg ${idx+1}: ${pts.toFixed(1)} QC ${pts >= (annualProj.details.capApplied || 12) ? '(Capped)' : ''}
                                            </div>
                                        `).join('') : '<span class="text-purple-300">No qualified legs yet</span>'}
                                    </div>
                                </div>
                                
                                <!-- Total Annual Projection -->
                                <div class="mt-6 pt-6 border-t border-purple-700">
                                    <div class="grid grid-cols-3 gap-4 text-center">
                                        <div>
                                            <div class="text-sm text-purple-200">Monthly Ã— 12</div>
                                            <div class="text-xl font-bold">$${annualProj.monthlyProjected.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                                        </div>
                                        <div>
                                            <div class="text-sm text-purple-200">Annual Bonus</div>
                                            <div class="text-xl font-bold">$${annualProj.annualBonus.toLocaleString()}</div>
                                        </div>
                                        <div class="bg-yellow-500 bg-opacity-30 rounded p-2">
                                            <div class="text-sm text-yellow-200">Total Annual</div>
                                            <div class="text-2xl font-bold text-yellow-300">$${annualProj.totalAnnual.toLocaleString('en-US', {maximumFractionDigits: 0})}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- FAA Super Leg Analysis -->
                            ${faaProj.totalPoints > 0 ? `
                            <div class="mt-6 bg-gradient-to-r from-amber-600 to-orange-600 text-white rounded-lg p-6 shadow-xl">
                                <h4 class="text-lg font-bold mb-4">
                                    <i class="fas fa-gem mr-2"></i>FAA Super Leg Analysis
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                    <div>
                                        <div class="text-sm text-amber-200">Total Points</div>
                                        <div class="text-2xl font-bold">${faaProj.totalPoints.toFixed(1)}</div>
                                        <div class="text-xs text-amber-300">Cap: 30/leg</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-amber-200">Super Legs</div>
                                        <div class="text-2xl font-bold">${faaProj.superLegs}</div>
                                        <div class="text-xs text-amber-300">30+ pts each</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-amber-200">Multiplier</div>
                                        <div class="text-2xl font-bold">${(faaProj.multiplier * 100).toFixed(0)}%</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-amber-200">Super Leg Bonus</div>
                                        <div class="text-2xl font-bold">$${faaProj.superLegBonus.toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="mt-4 text-xs text-amber-200">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Super Leg = 30+ points (â‰ˆ10 Diamonds). Cap ensures width over depth.
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Expert Formula Explanation -->
                            <div class="mt-6 bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                                <h4 class="text-lg font-bold text-blue-800 mb-3">
                                    <i class="fas fa-calculator mr-2"></i>Expert Income Formula Summary
                                </h4>
                                <div class="text-sm text-blue-700 space-y-2">
                                    <p><strong>Monthly Income = </strong>Performance + Differential + Leadership(6%) + Depth(1%) + Ruby(2%) + Retail + CSI</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                        <div class="bg-white rounded p-3">
                                            <div class="font-bold text-blue-800">Leadership Bonus (6%)</div>
                                            <div class="text-xs mt-1">
                                                â€¢ <strong>Pass-Up Thresholds:</strong><br/>
                                                â€¢ Side PV â‰¥ 7,500: Keep full 6%<br/>
                                                â€¢ 2,500 â‰¤ Side PV < 7,500: Partial<br/>
                                                â€¢ Side PV < 2,500: Pass up 100%
                                            </div>
                                        </div>
                                        <div class="bg-white rounded p-3">
                                            <div class="font-bold text-blue-800">Depth Bonus (1%)</div>
                                            <div class="text-xs mt-1">
                                                â€¢ <strong>Blocking Rule:</strong><br/>
                                                â€¢ Requires 3+ qualified legs<br/>
                                                â€¢ Blocked by downline leaders with 3+ legs<br/>
                                                â€¢ After block: +2 more levels, then STOP
                                            </div>
                                        </div>
                                        <div class="bg-white rounded p-3">
                                            <div class="font-bold text-blue-800">GAR Points (Annual)</div>
                                            <div class="text-xs mt-1">
                                                â€¢ Platinum: 1.0 QC<br/>
                                                â€¢ Emerald: 1.5 QC<br/>
                                                â€¢ Diamond: 3.0 QC<br/>
                                                â€¢ Cap: 6-12 QC per leg (by rank)
                                            </div>
                                        </div>
                                        <div class="bg-white rounded p-3">
                                            <div class="font-bold text-blue-800">FAA Points (Annual)</div>
                                            <div class="text-xs mt-1">
                                                â€¢ Same point values as GAR<br/>
                                                â€¢ Cap: 30 points per leg<br/>
                                                â€¢ Super Leg: 30+ points = $25k bonus<br/>
                                                â€¢ 10 Diamonds = 30 points (capped)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ============================================
            // CALCULATION METHODS
            // ============================================
            
            /**
             * AMWAY COMPENSATION PLAN CALCULATIONS
             * Based on Money & Rewards Reference Guide
             * 
             * KEY CONCEPTS:
             * - Group Volume: Personal PV + Pass-up from non-25% legs
             * - Ruby/Side Volume: PV outside any qualified 25% legs (critical for bonuses)
             * - Performance Bonus: Based on total Group PV bracket Ã— Group BV
             * - Differential Bonus: Difference between your % and downline's %
             * - Leadership Bonus: 6% on 25% legs, computed bottom-up
             * - Ruby Bonus: 2% of Ruby BV when Ruby PV â‰¥ 15,000
             * 
             * @param {string} perspectiveNodeId - Optional: View income from this IBO's perspective
             */
            
            calculateIncome(perspectiveNodeId = null) {
                // Use the specified perspective node, or the current income perspective, or root
                const nodeId = perspectiveNodeId || this.state.incomePerspectiveNode || 'root';
                const perspectiveNode = this.state.organization.get(nodeId);
                
                if (!perspectiveNode) {
                    return this.getEmptyIncomeResult();
                }
                
                // Calculate all the key metrics for this perspective
                const metrics = this.calculateAllMetricsForNode(perspectiveNode);
                
                /**
                 * CORRECT AMWAY INCOME CALCULATION
                 * 
                 * The key insight: You earn Performance Bonus ONLY on your "bonusable" volume:
                 * - Your personal PV/BV
                 * - Volume from NON-qualified legs (legs under 7500 PV)
                 * 
                 * For 25% qualified legs:
                 * - They earn their own 25% Performance Bonus
                 * - You earn 0% Differential (25% - 25% = 0%)
                 * - You MAY earn 6% Leadership Bonus IF you have sufficient Side Volume
                 */
                
                // 1. PERFORMANCE BONUS (Core Plan)
                // Based on YOUR personal rate Ã— YOUR bonusable volume (Side Volume only!)
                // Your rate is determined by total Group PV, but you only earn on Side Volume
                const performanceRate = this.getPerformanceLevel(metrics.groupPV) / 100;
                
                // Performance Bonus is ONLY on Side Volume (personal + non-qualified legs)
                // NOT on 25% qualified legs - they pay themselves
                const performanceBonus = metrics.rubyBV * performanceRate;
                
                // 2. DIFFERENTIAL BONUS (Core Plan)
                // Paid on NON-qualified legs only (difference between your % and their %)
                // For 25% legs, differential is 0% (25% - 25% = 0%), so no differential earned
                let differentialBonus = 0;
                if (perspectiveNode.children && perspectiveNode.children.length > 0) {
                    perspectiveNode.children.forEach(childId => {
                        const childGroupPV = this.calculateGroupPV(childId);
                        const childGroupBV = this.calculateGroupBV(childId);
                        const childRate = this.getPerformanceLevel(childGroupPV) / 100;
                        
                        // Only calculate differential on NON-qualified legs
                        // Qualified legs (25%) give 0 differential since 25% - 25% = 0%
                        if (childGroupPV < 7500) {
                            const differential = Math.max(0, performanceRate - childRate);
                            differentialBonus += childGroupBV * differential;
                        }
                        // Note: For 25% legs, you could earn Leadership Bonus instead (see below)
                    });
                }
                
                // 3. LEADERSHIP BONUS (Core Plan)
                // 6% on qualified 25% legs - BUT requires sufficient Side Volume!
                // Side Volume must be >= 2,500 PV to earn ANY Leadership Bonus
                let leadershipBonus = 0;
                if (performanceRate >= 0.25 && metrics.rubyPV >= 2500) {
                    leadershipBonus = this.calculateLeadershipBonusAmountForNode(perspectiveNode, metrics);
                }
                
                // 4. RUBY BONUS (Core Plan)
                // 2% of Ruby BV when Ruby PV â‰¥ 15,000
                let rubyBonus = 0;
                if (metrics.rubyPV >= 15000) {
                    rubyBonus = metrics.rubyBV * 0.02;
                }
                
                // 5. RETAIL MARGIN (Core Plan)
                // 10% on YOUR personal retail sales only
                const yourPersonalPV = perspectiveNode.pv || 0;
                const yourPersonalBV = perspectiveNode.bv || (yourPersonalPV * this.config.pvToBvRatio);
                const retailMargin = yourPersonalBV * 0.10;
                
                // 6. CUSTOMER SALES INCENTIVE (Core Plus)
                // Up to 10% of VCS BV for IBOs at 9% or below, max $75/month
                let customerSalesIncentive = 0;
                if (performanceRate <= 0.09) {
                    const csiRate = 0.10 - performanceRate;
                    const vcsBV = (perspectiveNode.vcsPV || yourPersonalPV * 0.6) * this.config.pvToBvRatio;
                    customerSalesIncentive = Math.min(75, vcsBV * csiRate);
                }
                
                // 7. DEPTH BONUS (Core Plan - Emerald+)
                // 1% on qualified downlines starting from Level 2
                // Requires 3+ qualified legs, with blocking logic
                const depthBonus = this.calculateDepthBonusAmountForNode(perspectiveNode);
                
                // Calculate potential Leadership Bonus (what you WOULD earn with full side volume)
                // This is used for the warning display
                let potentialLeadershipBonus = 0;
                if (metrics.qualifiedLegs > 0 && perspectiveNode.children) {
                    perspectiveNode.children.forEach(childId => {
                        const legPV = this.calculateGroupPV(childId);
                        const legBV = this.calculateGroupBV(childId);
                        if (legPV >= 7500) {
                            potentialLeadershipBonus += legBV * 0.06;
                        }
                    });
                }
                
                // Calculate totals
                const coreTotal = performanceBonus + differentialBonus + leadershipBonus + rubyBonus + retailMargin + depthBonus;
                const corePlusTotal = customerSalesIncentive;
                const total = coreTotal + corePlusTotal;
                
                return {
                    // Core Plan Bonuses
                    performanceBonus,
                    differentialBonus,
                    leadershipBonus,
                    depthBonus,
                    rubyBonus,
                    retailMargin,
                    
                    // Core Plus Incentives
                    customerSalesIncentive,
                    
                    // Totals
                    coreTotal,
                    corePlusTotal,
                    total,
                    
                    // Metrics for display
                    totalPV: metrics.groupPV,
                    totalBV: metrics.groupBV,
                    rubyPV: metrics.rubyPV,
                    rubyBV: metrics.rubyBV,
                    sidePV: this.calculateSidePVForNode(nodeId),
                    sideBV: this.calculateSideBVForNode(nodeId),
                    personalPV: yourPersonalPV,
                    personalBV: yourPersonalBV,
                    qualifiedLegs: metrics.qualifiedLegs,
                    performanceLevel: performanceRate * 100,
                    vcsCompliantBV: metrics.vcsCompliantBV,
                    potentialLeadershipBonus,
                    perspectiveNodeId: nodeId,
                    perspectiveNodeName: perspectiveNode.name
                };
            }
            
            /**
             * Calculate all key metrics for any IBO node (not just root)
             */
            calculateAllMetricsForNode(node) {
                return this.calculateAllMetrics(node);
            }
            
            /**
             * Calculate all key metrics for any IBO node
             */
            calculateAllMetrics(targetNode) {
                let groupPV = 0;
                let groupBV = 0;
                let rubyPV = 0;
                let rubyBV = 0;
                let vcsCompliantBV = 0;
                let qualifiedLegs = 0;
                
                // Personal volume always counts
                const personalPV = targetNode.pv || 0;
                const personalBV = targetNode.bv || (personalPV * this.config.pvToBvRatio);
                
                groupPV += personalPV;
                groupBV += personalBV;
                rubyPV += personalPV;
                rubyBV += personalBV;
                
                // Check VCS compliance for this node
                const nodeVCS = this.checkVCSCompliance(targetNode);
                if (nodeVCS.compliant) {
                    vcsCompliantBV += personalBV;
                }
                
                // Process each frontline leg
                if (targetNode.children && targetNode.children.length > 0) {
                    targetNode.children.forEach(childId => {
                        const legPV = this.calculateGroupPV(childId);
                        const legBV = this.calculateGroupBV(childId);
                        const legPerformanceLevel = this.getPerformanceLevel(legPV);
                        
                        // Check if this leg is qualified at 25%
                        const isQualifiedLeg = legPerformanceLevel >= 25 || legPV >= 7500;
                        
                        if (isQualifiedLeg) {
                            // Qualified 25% leg - counts toward Group but NOT Ruby/Side Volume
                            qualifiedLegs++;
                            groupPV += legPV;
                            groupBV += legBV;
                            // Ruby Volume does NOT include qualified 25% legs
                        } else {
                            // Non-qualified leg - counts toward both Group AND Ruby Volume
                            groupPV += legPV;
                            groupBV += legBV;
                            rubyPV += legPV;
                            rubyBV += legBV;
                        }
                        
                        // Count VCS compliant BV in this leg
                        vcsCompliantBV += this.calculateVCSCompliantBV(childId);
                    });
                }
                
                return {
                    groupPV,
                    groupBV,
                    rubyPV,
                    rubyBV,
                    personalPV,
                    personalBV,
                    qualifiedLegs,
                    vcsCompliantBV
                };
            }
            
            /**
             * Calculate VCS compliant BV for a node and all its descendants
             */
            calculateVCSCompliantBV(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node) return 0;
                
                let compliantBV = 0;
                const vcsStatus = this.checkVCSCompliance(node);
                if (vcsStatus.compliant) {
                    compliantBV += node.bv || (node.pv * this.config.pvToBvRatio);
                }
                
                if (node.children && node.children.length > 0) {
                    node.children.forEach(childId => {
                        compliantBV += this.calculateVCSCompliantBV(childId);
                    });
                }
                
                return compliantBV;
            }
            
            // ==========================================
            // EXPERT FORMULA: SIDE VOLUME CALCULATIONS
            // ==========================================
            
            /**
             * Calculates Side Volume (Ruby PV)
             * Total PV minus any downline leg that has reached 25% (7,500 PV)
             * This is the critical metric for Leadership Bonus eligibility
             */
            calculateSidePV(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node) return 0;

                let sidePV = node.pv; // Start with personal PV

                if (node.children) {
                    node.children.forEach(childId => {
                        const legTotalPV = this.calculateGroupPV(childId);
                        // If leg is NOT qualified ( < 7500), it counts as Side Volume
                        if (legTotalPV < 7500) {
                            sidePV += legTotalPV;
                        }
                        // Qualified legs (7500+) do NOT count toward Side Volume
                    });
                }
                return sidePV;
            }
            
            // Alias for perspective-based calculation
            calculateSidePVForNode(nodeId) {
                return this.calculateSidePV(nodeId);
            }

            /**
             * Calculates Side BV (Ruby BV) - Payment currency for Side Volume
             */
            calculateSideBV(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node) return 0;

                // Start with personal BV (adjusted for VCS compliance if needed)
                const vcsStatus = this.checkVCSCompliance(node);
                let sideBV = vcsStatus.effectiveBV;

                if (node.children) {
                    node.children.forEach(childId => {
                        const legTotalPV = this.calculateGroupPV(childId);
                        // Only add BV from non-qualified legs
                        if (legTotalPV < 7500) {
                            sideBV += this.calculateGroupBV(childId);
                        }
                    });
                }
                return sideBV;
            }
            
            // Alias for perspective-based calculation
            calculateSideBVForNode(nodeId) {
                return this.calculateSideBV(nodeId);
            }
            
            /**
             * Count qualified legs (legs at 25%/7500+ PV)
             */
            countQualifiedLegs(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node || !node.children) return 0;
                
                let count = 0;
                node.children.forEach(childId => {
                    const legPV = this.calculateGroupPV(childId);
                    if (legPV >= 7500) count++;
                });
                return count;
            }
            
            /**
             * EXPERT FORMULA: Leadership Bonus with Pass-Up Logic (6-4-2 Rule)
             * 
             * Leadership Bonus = 6% of BV from qualified 25% legs
             * 
             * Pass-Up Thresholds (based on Side Volume):
             * - Side PV >= 7,500: Keep full 6% (no adjustment)
             * - 2,500 <= Side PV < 7,500: Partial - pass up shortfall to ensure upline gets minimum
             * - Side PV < 2,500: Pass up 100% of Leadership Bonus
             * 
             * The "guaranteed minimum" ensures uplines receive at least:
             * 7,500 PV Ã— ratio Ã— 6% = $1,543 (approx) per qualified leg
             */
            calculateLeadershipBonusAmount(node, metrics) {
                let leadershipBonus = 0;
                
                if (!node.children || node.children.length === 0) return 0;
                
                const sidePV = metrics.rubyPV; // Ruby PV = Side Volume
                const leadershipRate = 0.06; // 6%
                
                // Case C: If Side PV < 2,500, you are NOT eligible for Leadership Bonus
                // The entire bonus passes up to your qualified upline
                if (sidePV < 2500) {
                    return 0;
                }
                
                // Calculate the total "Pass-Up Adjustment" you owe to your upline
                // If Side PV >= 7,500, adjustment is 0
                // If 2,500 <= Side PV < 7,500, adjustment is (7,500 - SidePV) * ratio * 6%
                let totalPassUpAdjustment = 0;
                if (sidePV < 7500) {
                    const shortfall = 7500 - sidePV;
                    totalPassUpAdjustment = shortfall * this.config.pvToBvRatio * leadershipRate;
                }
                
                // Calculate 6% on each qualified leg
                node.children.forEach(childId => {
                    const legPV = this.calculateGroupPV(childId);
                    const legBV = this.calculateGroupBV(childId);
                    
                    // Only 25% qualified legs (7,500+ PV) generate Leadership Bonus
                    if (legPV >= 7500) {
                        // Base bonus: 6% of the leg's BV
                        const legBonus = legBV * leadershipRate;
                        
                        // Check for downline leaders who also qualify for Leadership
                        // This handles the "blocking" within the Leadership Bonus itself
                        const downlineLeadershipDeduction = this.calculateDownlineLeadershipDeduction(childId);
                        
                        leadershipBonus += Math.max(0, legBonus - downlineLeadershipDeduction);
                    }
                });
                
                // Apply the pass-up deduction (for Side Volume shortfall)
                leadershipBonus = Math.max(0, leadershipBonus - totalPassUpAdjustment);
                
                return leadershipBonus;
            }
            
            // Alias for perspective-based calculation
            calculateLeadershipBonusAmountForNode(node, metrics) {
                return this.calculateLeadershipBonusAmount(node, metrics);
            }
            
            /**
             * Calculate deduction for downline leaders who also earn Leadership Bonus
             * This implements the bottom-up calculation where downline Platinums
             * take their portion first
             */
            calculateDownlineLeadershipDeduction(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node || !node.children) return 0;
                
                let deduction = 0;
                
                node.children.forEach(childId => {
                    const childGroupPV = this.calculateGroupPV(childId);
                    const childGroupBV = this.calculateGroupBV(childId);
                    
                    // If this downline is also at 25%, they earn Leadership on their legs
                    if (childGroupPV >= 7500) {
                        // Check if this person has qualifying Side Volume to keep their bonus
                        const childSidePV = this.calculateSidePV(childId);
                        
                        if (childSidePV >= 2500) {
                            // They keep some/all of the 6%, so we don't get it
                            deduction += childGroupBV * 0.06;
                        }
                        // If childSidePV < 2500, they pass it all up, so we keep it
                    }
                });
                
                return deduction;
            }
            
            /**
             * Find if there's a qualified Platinum (7500+ PV) in a leg
             */
            findQualifiedPlatinumInLeg(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node) return null;
                
                // Check if this node qualifies as Platinum
                const nodePV = this.calculateGroupPV(nodeId);
                if (nodePV >= 7500) {
                    return node;
                }
                
                // Check children recursively
                if (node.children && node.children.length > 0) {
                    for (const childId of node.children) {
                        const found = this.findQualifiedPlatinumInLeg(childId);
                        if (found) return found;
                    }
                }
                
                return null;
            }
            
            // ==========================================
            // EXPERT FORMULA: DEPTH BONUS (1%) WITH BLOCKING
            // ==========================================
            
            /**
             * Calculate Depth Bonus
             * 
             * Eligibility: You must have 3+ qualified frontline legs (Silver Producer or above)
             * Rate: 1% on qualified downlines starting from Level 2
             * 
             * BLOCKING RULE:
             * - Earn 1% on qualified volume down the line
             * - STOP when hitting a downline who also qualifies for Depth Bonus (3+ qualified legs)
             * - When blocked: You get 1% on the blocker + their frontline + their 2nd level, then STOP
             */
            calculateDepthBonusAmount(node) {
                // Requires 3+ qualified legs to activate Depth Bonus
                const nodeId = node.id || 'root';
                const qualifiedLegsCount = this.countQualifiedLegs(nodeId);
                if (qualifiedLegsCount < 3) return 0;
                
                let depthBonus = 0;
                
                if (node.children) {
                    node.children.forEach(childId => {
                        const legPV = this.calculateGroupPV(childId);
                        
                        // Only process qualified legs (7500+ PV)
                        if (legPV >= 7500) {
                            // Start recursive calculation from Level 2 (child's children)
                            const childNode = this.state.organization.get(childId);
                            if (childNode && childNode.children) {
                                childNode.children.forEach(grandChildId => {
                                    depthBonus += this.calculateRecursiveDepthBonus(grandChildId, -1);
                                });
                            }
                        }
                    });
                }
                
                return depthBonus;
            }
            
            // Alias for perspective-based calculation
            calculateDepthBonusAmountForNode(node) {
                return this.calculateDepthBonusAmount(node);
            }
            
            /**
             * Recursive Depth Bonus Calculation with Blocking Logic
             * 
             * Logic: Earn 1% until you hit a downline who ALSO qualifies for Depth Bonus (3+ legs).
             * If they qualify, you get 1% on them, their children, and their grandchildren, then STOP.
             * 
             * @param nodeId - Current node to process
             * @param depthCountAfterBlock - Tracks levels after hitting a "blocker"
             *   -1 = not blocked yet
             *   0 = just hit the blocker (earn on this level)
             *   1 = first level after blocker (earn on frontline)
             *   2 = second level after blocker (earn on 2nd level, then STOP)
             */
            calculateRecursiveDepthBonus(nodeId, depthCountAfterBlock = -1) {
                const node = this.state.organization.get(nodeId);
                if (!node) return 0;

                const groupPV = this.calculateGroupPV(nodeId);
                
                // Only paid on qualified groups (7500+ PV)
                if (groupPV < 7500) return 0;

                const groupBV = this.calculateGroupBV(nodeId);
                let bonus = groupBV * 0.01; // 1%

                // CHECK FOR BLOCKING: Does this person have 3+ qualified legs?
                let qualifiedLegs = 0;
                if (node.children) {
                    node.children.forEach(c => {
                        if (this.calculateGroupPV(c) >= 7500) qualifiedLegs++;
                    });
                }

                let nextDepthCount = depthCountAfterBlock;

                // If we are already blocked, increment counter
                if (depthCountAfterBlock >= 0) {
                    nextDepthCount++;
                }
                // If we hit a new blocker, start the countdown (we get this level + 2 more)
                else if (qualifiedLegs >= 3) {
                    nextDepthCount = 0; 
                }

                // Stop condition: If we've gone 2 levels past the blocker, STOP
                if (depthCountAfterBlock >= 2) {
                    return 0; 
                }

                // Continue recursively through children
                let childBonus = 0;
                if (node.children) {
                    node.children.forEach(childId => {
                        childBonus += this.calculateRecursiveDepthBonus(childId, nextDepthCount);
                    });
                }

                return bonus + childBonus;
            }
            
            /**
             * Empty income result for when there's no organization
             */
            getEmptyIncomeResult() {
                return {
                    performanceBonus: 0,
                    differentialBonus: 0,
                    leadershipBonus: 0,
                    depthBonus: 0,
                    rubyBonus: 0,
                    retailMargin: 0,
                    customerSalesIncentive: 0,
                    coreTotal: 0,
                    corePlusTotal: 0,
                    total: 0,
                    totalPV: 0,
                    totalBV: 0,
                    rubyPV: 0,
                    rubyBV: 0,
                    sidePV: 0,
                    sideBV: 0,
                    personalPV: 0,
                    personalBV: 0,
                    qualifiedLegs: 0,
                    performanceLevel: 0,
                    vcsCompliantBV: 0
                };
            }
            
            calculateAllIncentives() {
                const income = this.calculateIncome();
                const root = this.state.organization.get('root');
                const incentives = [];
                
                // Get metrics for incentive calculations
                const metrics = root ? this.calculateAllMetrics(root) : null;
                
                // 1. Strong Start Incentive (SSI) - Core Plus
                if (root) {
                    const ssi = this.calculateSSI(root);
                    incentives.push(ssi);
                }
                
                // 2. Bronze Foundation Incentive (BFI) - Core Plus
                const bfi = this.calculateBFI(income, root);
                incentives.push(bfi);
                
                // 3. Bronze Builder Incentive (BBI) - Core Plus
                const bbi = this.calculateBBI(income, root);
                incentives.push(bbi);
                
                // 4. Performance Plus Incentive - Core Plus
                const perfPlus = this.calculatePerformancePlus(income, metrics);
                incentives.push(perfPlus);
                
                // 5. Performance Elite Incentive - Core Plus
                const perfElite = this.calculatePerformanceElite(income, metrics);
                incentives.push(perfElite);
                
                // 6. Ruby Bonus (already in Core Plan, show for reference)
                incentives.push({
                    name: 'Ruby Bonus',
                    amount: income.rubyBonus,
                    qualified: income.rubyBonus > 0,
                    description: income.rubyBonus > 0 ? '2% of Ruby BV for 15,000+ Ruby PV' : 'Requires 15,000+ Ruby PV',
                    details: {
                        'Ruby PV': metrics ? metrics.rubyPV.toFixed(0) : '0',
                        'Ruby BV': metrics ? metrics.rubyBV.toFixed(2) : '0',
                        'Qualified Legs': metrics ? metrics.qualifiedLegs : 0
                    }
                });
                
                // 7. Leadership Bonus (already in Core Plan, show for reference)
                incentives.push({
                    name: 'Leadership Bonus (6%)',
                    amount: income.leadershipBonus,
                    qualified: income.leadershipBonus > 0,
                    description: income.leadershipBonus > 0 
                        ? '6% on qualified 25% legs (with Pass-Up logic)' 
                        : 'Requires 25% level + 2,500+ Side PV',
                    details: {
                        'Your Level': income.performanceLevel.toFixed(0) + '%',
                        'Qualified Legs': metrics ? metrics.qualifiedLegs : 0,
                        'Side PV': income.sidePV ? income.sidePV.toFixed(0) : (metrics ? metrics.rubyPV.toFixed(0) : '0'),
                        'Pass-Up Status': income.sidePV >= 7500 ? 'Full (7,500+)' : (income.sidePV >= 2500 ? 'Partial' : 'None (<2,500)')
                    }
                });
                
                // 8. Depth Bonus (Core Plan - Emerald+)
                const depthBonus = this.calculateDepthBonus(income, root);
                incentives.push(depthBonus);
                
                const total = incentives.reduce((sum, inc) => sum + (inc.amount || 0), 0);
                
                return { total, breakdown: incentives };
            }
            
            calculateSSI(node) {
                if (!node) {
                    return { name: 'Strong Start Incentive (SSI)', amount: 0, qualified: false, description: 'No IBO data' };
                }
                
                const registrationDate = new Date(node.registrationDate || new Date());
                const monthsSinceRegistration = this.getMonthsSince(registrationDate);
                
                // SSI only available for first 12 months
                if (monthsSinceRegistration > 12) {
                    return { name: 'Strong Start Incentive (SSI)', amount: 0, qualified: false, description: 'Expired (>12 months)' };
                }
                
                // Check if meeting baseline requirements
                const meetsBaseline = node.pv >= 150 && this.checkVCSCompliance(node).compliant;
                
                let bonus = 0;
                let description = 'Not qualified';
                
                if (meetsBaseline) {
                    if (monthsSinceRegistration <= 3) {
                        bonus = 100;
                        description = 'First 3 months bonus';
                    } else if (monthsSinceRegistration <= 6) {
                        bonus = 200;
                        description = 'First 6 months bonus';
                    } else if (monthsSinceRegistration <= 12) {
                        bonus = 400;
                        description = 'First 12 months bonus';
                    }
                }
                
                return {
                    name: 'Strong Start Incentive (SSI)',
                    amount: bonus,
                    qualified: bonus > 0,
                    description: bonus > 0 ? description : 'Requires 150 PV + 60% VCS',
                    details: {
                        'Months Since Registration': monthsSinceRegistration,
                        'Max Potential': '$1,000 total'
                    }
                };
            }
            
            calculateBFI(income, root) {
                const performanceLevel = this.getPerformanceLevel(income.totalPV);
                
                // BFI does not apply at Silver (7,500+ PV) or above
                if (income.totalPV >= 7500) {
                    return { 
                        name: 'Bronze Foundation Incentive (BFI)', 
                        amount: 0, 
                        qualified: false, 
                        description: 'Not available at Silver (7,500+ PV) or above'
                    };
                }
                
                // Must be at 9% or higher
                if (performanceLevel < 9) {
                    return { 
                        name: 'Bronze Foundation Incentive (BFI)', 
                        amount: 0, 
                        qualified: false, 
                        description: 'Requires 9%+ level (600+ PV)'
                    };
                }
                
                // Need 3 personally sponsored legs at 3%+ each
                let qualifyingLegs = 0;
                if (root && root.children) {
                    qualifyingLegs = root.children.filter(childId => {
                        const childPV = this.calculateGroupPV(childId);
                        return this.getPerformanceLevel(childPV) >= 3;
                    }).length;
                }
                
                if (qualifyingLegs < 3) {
                    return { 
                        name: 'Bronze Foundation Incentive (BFI)', 
                        amount: 0, 
                        qualified: false, 
                        description: `Need 3+ legs at 3%+ (have ${qualifyingLegs})`
                    };
                }
                
                // Must meet baseline (150 PV, 60% VCS)
                const meetsBaseline = root && root.pv >= 150 && this.checkVCSCompliance(root).compliant;
                if (!meetsBaseline) {
                    return { 
                        name: 'Bronze Foundation Incentive (BFI)', 
                        amount: 0, 
                        qualified: false, 
                        description: 'Need 150 Personal PV + 60% VCS'
                    };
                }
                
                // 30% multiplier on Performance Bonus
                const multiplierBonus = income.performanceBonus * 0.30;
                
                return {
                    name: 'Bronze Foundation Incentive (BFI)',
                    amount: multiplierBonus,
                    qualified: true,
                    description: '30% multiplier on Performance Bonus',
                    details: {
                        'Performance Bonus': '$' + income.performanceBonus.toFixed(2),
                        'Qualifying Legs (3%+)': qualifyingLegs,
                        'Multiplier': '30%'
                    }
                };
            }
            
            calculateBBI(income, root) {
                const performanceLevel = this.getPerformanceLevel(income.totalPV);
                
                // BBI does not apply at Silver (7,500+ PV) or above
                if (income.totalPV >= 7500) {
                    return { 
                        name: 'Bronze Builder Incentive (BBI)', 
                        amount: 0, 
                        qualified: false, 
                        description: 'Not available at Silver (7,500+ PV) or above'
                    };
                }
                
                // Must be at 18% or higher
                if (performanceLevel < 18) {
                    return { 
                        name: 'Bronze Builder Incentive (BBI)', 
                        amount: 0, 
                        qualified: false, 
                        description: 'Requires 18%+ level (2,500+ PV)'
                    };
                }
                
                // Need 3 personally sponsored legs at 6%+ each
                let qualifyingLegs = 0;
                if (root && root.children) {
                    qualifyingLegs = root.children.filter(childId => {
                        const childPV = this.calculateGroupPV(childId);
                        return this.getPerformanceLevel(childPV) >= 6;
                    }).length;
                }
                
                if (qualifyingLegs < 3) {
                    return { 
                        name: 'Bronze Builder Incentive (BBI)', 
                        amount: 0, 
                        qualified: false, 
                        description: `Need 3+ legs at 6%+ (have ${qualifyingLegs})`
                    };
                }
                
                // Must meet baseline
                const meetsBaseline = root && root.pv >= 150 && this.checkVCSCompliance(root).compliant;
                if (!meetsBaseline) {
                    return { 
                        name: 'Bronze Builder Incentive (BBI)', 
                        amount: 0, 
                        qualified: false, 
                        description: 'Need 150 Personal PV + 60% VCS'
                    };
                }
                
                // 40% multiplier on Performance Bonus
                const multiplierBonus = income.performanceBonus * 0.40;
                
                return {
                    name: 'Bronze Builder Incentive (BBI)',
                    amount: multiplierBonus,
                    qualified: true,
                    description: '40% multiplier on Performance Bonus',
                    details: {
                        'Performance Bonus': '$' + income.performanceBonus.toFixed(2),
                        'Qualifying Legs (6%+)': qualifyingLegs,
                        'Multiplier': '40%'
                    }
                };
            }
            
            /**
             * Performance Plus Incentive
             * 2% multiplier on Ruby BV for 10,000-12,499 Ruby PV
             */
            calculatePerformancePlus(income, metrics) {
                if (!metrics) {
                    return { name: 'Performance Plus', amount: 0, qualified: false, description: 'No data' };
                }
                
                // Must be Silver Producer level or above
                if (income.totalPV < 7500) {
                    return { 
                        name: 'Performance Plus', 
                        amount: 0, 
                        qualified: false, 
                        description: 'Requires Silver level (7,500+ PV)'
                    };
                }
                
                // Ruby PV must be 10,000-12,499
                if (metrics.rubyPV < 10000 || metrics.rubyPV >= 12500) {
                    return { 
                        name: 'Performance Plus', 
                        amount: 0, 
                        qualified: false, 
                        description: 'Requires 10,000-12,499 Ruby PV'
                    };
                }
                
                // 2% of Ruby BV
                const bonus = metrics.rubyBV * 0.02;
                
                return {
                    name: 'Performance Plus',
                    amount: bonus,
                    qualified: true,
                    description: '2% multiplier on Ruby BV',
                    details: {
                        'Ruby PV': metrics.rubyPV.toFixed(0),
                        'Ruby BV': metrics.rubyBV.toFixed(2),
                        'Multiplier': '2%'
                    }
                };
            }
            
            /**
             * Performance Elite Incentive
             * 4% multiplier on Ruby BV for 12,500+ Ruby PV
             */
            calculatePerformanceElite(income, metrics) {
                if (!metrics) {
                    return { name: 'Performance Elite', amount: 0, qualified: false, description: 'No data' };
                }
                
                // Must be Silver Producer level or above
                if (income.totalPV < 7500) {
                    return { 
                        name: 'Performance Elite', 
                        amount: 0, 
                        qualified: false, 
                        description: 'Requires Silver level (7,500+ PV)'
                    };
                }
                
                // Ruby PV must be 12,500+
                if (metrics.rubyPV < 12500) {
                    return { 
                        name: 'Performance Elite', 
                        amount: 0, 
                        qualified: false, 
                        description: 'Requires 12,500+ Ruby PV'
                    };
                }
                
                // 4% of Ruby BV
                const bonus = metrics.rubyBV * 0.04;
                
                return {
                    name: 'Performance Elite',
                    amount: bonus,
                    qualified: true,
                    description: '4% multiplier on Ruby BV',
                    details: {
                        'Ruby PV': metrics.rubyPV.toFixed(0),
                        'Ruby BV': metrics.rubyBV.toFixed(2),
                        'Multiplier': '4%'
                    }
                };
            }
            
            calculateRubyBonus(income) {
                // Now handled in main calculateIncome
                return {
                    name: 'Ruby Bonus',
                    amount: income.rubyBonus || 0,
                    qualified: (income.rubyBonus || 0) > 0,
                    description: (income.rubyBonus || 0) > 0 ? '2% of Ruby BV' : 'Requires 15,000+ Ruby PV'
                };
            }
            
            calculateLeadershipBonus(income, root) {
                // Now handled in main calculateIncome
                return {
                    name: 'Leadership Bonus',
                    amount: income.leadershipBonus || 0,
                    qualified: (income.leadershipBonus || 0) > 0,
                    description: (income.leadershipBonus || 0) > 0 ? '6% on 25% legs' : 'Requires 25% level'
                };
            }
            
            calculateDepthBonus(income, root) {
                // Expert formula: 1% Depth Bonus with blocking
                // Requires 3+ qualified legs (Emerald+)
                const qualifiedLegs = this.countQualifiedLegs('root');
                const depthBonus = qualifiedLegs >= 3 ? this.calculateDepthBonusAmount(root) : 0;
                
                return {
                    name: 'Depth Bonus (1%)',
                    amount: depthBonus,
                    qualified: depthBonus > 0,
                    description: depthBonus > 0 
                        ? '1% on qualified downline volume (with blocking)' 
                        : 'Requires 3+ qualified legs (Emerald+)',
                    details: {
                        'Qualified Legs': qualifiedLegs,
                        'Requirement': '3+ legs at 25%',
                        'Note': 'Blocked by downline leaders with 3+ legs'
                    }
                };
            }
            
            // ==========================================
            // ANNUAL PROJECTION ENGINE (GAR & FAA)
            // Expert Formula for Deep Organizations
            // ==========================================

            /**
             * Calculate Annual Business Projections
             * Includes GAR (Global Award Recognition) and FAA (Founders Achievement Award)
             * 
             * GAR Cap per leg: 6-12 QC depending on rank
             * FAA Cap per leg: 30 points (10 Diamonds)
             */
            calculateAnnualProjections() {
                const root = this.state.organization.get('root');
                if (!root) return { gar: null, income: 0 };

                // 1. Identify "Width" (Number of qualified frontline legs)
                let qualifiedFrontlineLegs = 0;
                const legData = [];

                if (root.children) {
                    root.children.forEach(childId => {
                        const legPV = this.calculateGroupPV(childId);
                        // Check if this leg is qualified (7500+ PV)
                        if (legPV >= 7500) {
                            qualifiedFrontlineLegs++;
                            
                            // 2. Calculate Depth Credits for this specific leg
                            const legCredits = this.calculateLegDepthCredits(childId);
                            legData.push(legCredits);
                        }
                    });
                }

                // 3. Determine GAR Award Level with dynamic caps
                const garResult = this.determineGARAwardLevel(qualifiedFrontlineLegs, legData);

                // 4. Calculate Estimated Annual Cash Award (Two-Time Cash)
                const annualCashAward = this.getGARCashAward(garResult.level);

                // 5. Calculate monthly income projection
                const monthlyIncome = this.calculateIncome();
                const monthlyProjected = monthlyIncome.total * 12;

                return {
                    level: garResult.level,
                    totalQC: garResult.totalQC,
                    cappedLegs: garResult.cappedLegCount,
                    annualBonus: annualCashAward,
                    monthlyProjected: monthlyProjected,
                    totalAnnual: monthlyProjected + annualCashAward,
                    details: garResult,
                    legData: legData
                };
            }

            /**
             * Recursively scans a leg to find all depth credits (Founders Platinum+)
             * Logic: FP=1.0, Emerald=1.5, Diamond=3.0
             */
            calculateLegDepthCredits(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node) return 0;

                let myCredits = 0;
                
                // Detect Leader Status of THIS node based on their downline structure
                const groupPV = this.calculateGroupPV(nodeId);
                
                // Count *their* qualified legs to determine *their* pin
                let childQualifiedLegs = 0;
                if (node.children) {
                    node.children.forEach(c => {
                        if (this.calculateGroupPV(c) >= 7500) childQualifiedLegs++;
                    });
                }

                // Assign Credits based on structure
                // Diamond (6+ qualified legs): 3.0 QC
                // Emerald (3-5 qualified legs): 1.5 QC
                // Founders Platinum (7500+ PV): 1.0 QC
                if (childQualifiedLegs >= 6) {
                    myCredits = 3.0; // Diamond Bonus Recipient (DBR)
                } else if (childQualifiedLegs >= 3) {
                    myCredits = 1.5; // Emerald Bonus Recipient (EBR)
                } else if (groupPV >= 7500) {
                    myCredits = 1.0; // Founders Platinum (FP)
                } else {
                    myCredits = 0;   // Not yet a leader that generates credits
                }

                // Recursively add credits from downline leaders
                let downlineCredits = 0;
                if (node.children) {
                    node.children.forEach(childId => {
                        downlineCredits += this.calculateLegDepthCredits(childId);
                    });
                }

                return myCredits + downlineCredits;
            }

            /**
             * Determines the GAR Award Level by applying dynamic caps
             * The cap changes based on the level you are aiming for.
             * 
             * GAR Tiers (from highest to lowest):
             * - Founders Crown Ambassador: 14+ legs, 100+ QC, cap=12
             * - Crown Ambassador: 14+ legs, 88+ QC, cap=12
             * - ... down to Executive Diamond: 6 legs, 10+ QC, cap=6
             */
            determineGARAwardLevel(fpLegs, legDataRaw) {
                // Define Tiers from the GAR Table (check from highest to lowest)
                const tiers = [
                    { name: 'Founders Crown Ambassador', minLegs: 14, minQC: 100, cap: 12 },
                    { name: 'Crown Ambassador',          minLegs: 14, minQC: 88,  cap: 12 },
                    { name: 'Founders Crown',            minLegs: 12, minQC: 76,  cap: 12 },
                    { name: 'Crown',                     minLegs: 12, minQC: 64,  cap: 12 },
                    { name: 'Founders Triple Diamond',   minLegs: 10, minQC: 52,  cap: 12 },
                    { name: 'Triple Diamond',            minLegs: 10, minQC: 43,  cap: 12 },
                    { name: 'Founders Double Diamond',   minLegs: 8,  minQC: 34,  cap: 9 },
                    { name: 'Double Diamond',            minLegs: 8,  minQC: 25,  cap: 9 },
                    { name: 'Founders Executive Diamond',minLegs: 6,  minQC: 16,  cap: 6 },
                    { name: 'Executive Diamond',         minLegs: 6,  minQC: 10,  cap: 6 }
                ];

                for (const tier of tiers) {
                    // 1. Check Width Requirement
                    if (fpLegs < tier.minLegs) continue;

                    // 2. Calculate Total QC with the Tier's specific Cap
                    let currentTotalQC = 0;
                    let cappedCount = 0;

                    for (const rawLegPoints of legDataRaw) {
                        // Apply Cap per leg
                        // Example: If leg has 100 Diamonds (300 pts), Cap at 12 for Crown Amb.
                        const pointsToAdd = Math.min(rawLegPoints, tier.cap);
                        
                        if (rawLegPoints > tier.cap) cappedCount++;
                        currentTotalQC += pointsToAdd;
                    }

                    // 3. Check Depth Requirement
                    if (currentTotalQC >= tier.minQC) {
                        return {
                            level: tier.name,
                            totalQC: currentTotalQC,
                            capApplied: tier.cap,
                            cappedLegCount: cappedCount,
                            rawLegData: legDataRaw
                        };
                    }
                }

                // If no executive level met, return base level
                return {
                    level: fpLegs >= 6 ? 'Diamond' : (fpLegs >= 3 ? 'Emerald' : (fpLegs >= 2 ? 'Sapphire' : (fpLegs >= 1 ? 'Platinum' : 'Below Platinum'))),
                    totalQC: legDataRaw.reduce((a, b) => a + b, 0),
                    capApplied: 0,
                    cappedLegCount: 0,
                    rawLegData: legDataRaw
                };
            }

            /**
             * Returns the "Year 1" Cash Award for the level
             * These are estimated Two-Time Cash Incentive values
             */
            getGARCashAward(levelName) {
                const awards = {
                    'Executive Diamond': 45000,
                    'Founders Executive Diamond': 51500,
                    'Double Diamond': 64300,
                    'Founders Double Diamond': 90000,
                    'Triple Diamond': 115800,
                    'Founders Triple Diamond': 154400,
                    'Crown': 205800,
                    'Founders Crown': 257300,
                    'Crown Ambassador': 308700,
                    'Founders Crown Ambassador': 360200,
                    'Diamond': 15000,
                    'Emerald': 8000,
                    'Sapphire': 4000,
                    'Platinum': 2500
                };
                return awards[levelName] || 0;
            }
            
            // ==========================================
            // FAA (FOUNDERS ACHIEVEMENT AWARD) SYSTEM
            // Alternative annual award with 30-point cap per leg
            // ==========================================
            
            /**
             * Calculate FAA Points with Super Leg logic
             * Cap per leg: 30 points (10 Diamonds)
             * Super Leg: A leg that has reached the 30-point cap
             */
            calculateFAAProjections() {
                const root = this.state.organization.get('root');
                if (!root) return { level: 'N/A', totalPoints: 0, superLegs: 0 };
                
                let totalPoints = 0;
                let superLegCount = 0;
                const legDetails = [];
                
                if (root.children) {
                    root.children.forEach(childId => {
                        const legPV = this.calculateGroupPV(childId);
                        if (legPV >= 7500) {
                            const rawPoints = this.calculateLegDepthCredits(childId);
                            // FAA Cap: 30 points per leg
                            const cappedPoints = Math.min(rawPoints, 30);
                            
                            if (rawPoints >= 30) {
                                superLegCount++;
                            }
                            
                            totalPoints += cappedPoints;
                            legDetails.push({
                                raw: rawPoints,
                                capped: cappedPoints,
                                isSuperLeg: rawPoints >= 30
                            });
                        }
                    });
                }
                
                // Calculate FAA multiplier (example: 200% - 750% based on points)
                let multiplier = 0;
                if (totalPoints >= 100) multiplier = 7.50;
                else if (totalPoints >= 75) multiplier = 5.00;
                else if (totalPoints >= 50) multiplier = 3.50;
                else if (totalPoints >= 30) multiplier = 2.50;
                else if (totalPoints >= 20) multiplier = 2.00;
                else if (totalPoints >= 10) multiplier = 1.50;
                
                // Super Leg Bonus: $20,000 - $40,000 per super leg
                const superLegBonus = superLegCount * 25000;
                
                return {
                    totalPoints: totalPoints,
                    superLegs: superLegCount,
                    multiplier: multiplier,
                    superLegBonus: superLegBonus,
                    legDetails: legDetails
                };
            }

            calculateGroupPV(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node) return 0;
                
                let total = node.pv;
                if (node.children) {
                    node.children.forEach(childId => {
                        total += this.calculateGroupPV(childId);
                    });
                }
                
                return total;
            }
            
            calculateGroupBV(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node) return 0;
                
                const vcsStatus = this.checkVCSCompliance(node);
                let total = vcsStatus.effectiveBV;
                
                if (node.children) {
                    node.children.forEach(childId => {
                        total += this.calculateGroupBV(childId);
                    });
                }
                
                return total;
            }
            
            checkVCSCompliance(node) {
                const totalPV = node.pv;
                const customerSalesPV = node.customerSalesPV || 0;
                const vcsPV = node.vcsPV || 0;
                
                const customerSalesPercentage = totalPV > 0 ? (customerSalesPV / totalPV) * 100 : 0;
                const vcsPercentage = totalPV > 0 ? (vcsPV / totalPV) * 100 : 0;
                
                const customerSalesCompliant = customerSalesPercentage >= 70;
                const vcsCompliant = vcsPercentage >= 60;
                const fullyCompliant = customerSalesCompliant && vcsCompliant;
                
                let prorationFactor = 1;
                if (!fullyCompliant) {
                    const customerSalesRatio = Math.min(customerSalesPercentage / 70, 1);
                    const vcsRatio = Math.min(vcsPercentage / 60, 1);
                    prorationFactor = Math.min(customerSalesRatio, vcsRatio);
                }
                
                return {
                    compliant: fullyCompliant,
                    customerSalesCompliant,
                    vcsCompliant,
                    prorationFactor,
                    effectiveBV: node.bv * prorationFactor
                };
            }
            
            getPerformanceLevel(pv) {
                for (const tier of this.config.performanceSchedule) {
                    if (pv >= tier.min && pv <= tier.max) {
                        return tier.rate;
                    }
                }
                return 0;
            }
            
            // ============================================
            // UI UPDATE METHODS
            // ============================================
            
            updateIncomeSummary() {
                const income = this.calculateIncome();
                const summaryDiv = document.getElementById('income-summary');
                const totalDiv = document.getElementById('total-income');
                
                // Check for side volume warnings
                const sidePV = income.sidePV || income.rubyPV;
                const hasQualifiedLegs = income.qualifiedLegs > 0;
                let sideVolumeWarning = '';
                
                if (hasQualifiedLegs && sidePV < 2500) {
                    sideVolumeWarning = `
                        <div class="bg-red-100 text-red-700 p-2 rounded text-xs mb-2">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            <strong>Side Volume Too Low!</strong> You have ${income.qualifiedLegs} qualified leg(s) but only ${sidePV.toLocaleString()} Side PV. 
                            Need 2,500+ Side PV to earn Leadership Bonus. Currently losing $${(income.potentialLeadershipBonus || 0).toFixed(2)}/month.
                        </div>
                    `;
                } else if (hasQualifiedLegs && sidePV < 7500) {
                    const shortfall = 7500 - sidePV;
                    const passUpAmount = shortfall * 3.43 * 0.06;
                    sideVolumeWarning = `
                        <div class="bg-yellow-100 text-yellow-700 p-2 rounded text-xs mb-2">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            <strong>Partial Side Volume:</strong> ${sidePV.toLocaleString()} / 7,500 PV. 
                            Passing up ~$${passUpAmount.toFixed(2)}/month to upline.
                        </div>
                    `;
                }
                
                if (summaryDiv) {
                    summaryDiv.innerHTML = `
                        ${sideVolumeWarning}
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                            <span>Group PV: ${income.totalPV.toLocaleString()}</span> | 
                            <span>Side PV: ${sidePV.toLocaleString()}</span> | 
                            <span>Qualified Legs: ${income.qualifiedLegs}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Performance Bonus (on Side Vol):</span>
                            <span class="font-semibold">$${income.performanceBonus.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Differential Bonus:</span>
                            <span class="font-semibold">$${income.differentialBonus.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between ${income.leadershipBonus === 0 && hasQualifiedLegs ? 'text-red-500' : ''}">
                            <span>Leadership Bonus (6%):</span>
                            <span class="font-semibold">$${income.leadershipBonus.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Depth Bonus (1%):</span>
                            <span class="font-semibold">$${(income.depthBonus || 0).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Ruby Bonus (2%):</span>
                            <span class="font-semibold">$${income.rubyBonus.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Retail Margin:</span>
                            <span class="font-semibold">$${income.retailMargin.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Customer Sales Incentive:</span>
                            <span class="font-semibold">$${income.customerSalesIncentive.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (totalDiv) {
                    totalDiv.textContent = '$' + income.total.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
                
                // Update perspective indicator
                this.updateIncomePerspectiveIndicator();
            }
            
            updateTeamStats() {
                const totalMembers = this.state.organization.size - 1;
                const income = this.calculateIncome();
                const performanceLevel = this.getPerformanceLevel(income.totalPV);
                
                let vcsCompliantCount = 0;
                this.state.organization.forEach(node => {
                    if (this.checkVCSCompliance(node).compliant) {
                        vcsCompliantCount++;
                    }
                });
                
                const totalMembersDiv = document.getElementById('total-members');
                const totalPVDiv = document.getElementById('total-pv');
                const vcsCompliantDiv = document.getElementById('vcs-compliant');
                const performanceLevelDiv = document.getElementById('performance-level');
                
                if (totalMembersDiv) totalMembersDiv.textContent = totalMembers;
                if (totalPVDiv) totalPVDiv.textContent = Math.round(income.totalPV);
                if (vcsCompliantDiv) vcsCompliantDiv.textContent = vcsCompliantCount;
                if (performanceLevelDiv) performanceLevelDiv.textContent = performanceLevel + '%';
            }
            
            updateVCSStatus() {
                if (!this.state.selectedNode) return;
                
                const node = this.state.organization.get(this.state.selectedNode);
                if (!node) return;
                
                const vcsStatus = this.checkVCSCompliance(node);
                const statusDiv = document.getElementById('vcs-status');
                
                if (statusDiv) {
                    const customerSalesPercentage = node.pv > 0 ? ((node.customerSalesPV || 0) / node.pv) * 100 : 0;
                    const vcsPercentage = node.pv > 0 ? ((node.vcsPV || 0) / node.pv) * 100 : 0;
                    
                    statusDiv.innerHTML = `
                        <div class="mt-2 p-2 rounded ${vcsStatus.compliant ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            <div class="font-semibold mb-1">${vcsStatus.compliant ? 'âœ“ VCS Compliant' : 'âš  VCS Non-Compliant'}</div>
                            <div>Customer Sales: ${customerSalesPercentage.toFixed(1)}% ${vcsStatus.customerSalesCompliant ? 'âœ“' : 'âœ—'} (70% required)</div>
                            <div>VCS: ${vcsPercentage.toFixed(1)}% ${vcsStatus.vcsCompliant ? 'âœ“' : 'âœ—'} (60% required)</div>
                            ${!vcsStatus.compliant ? `<div class="mt-1 font-semibold">BV Proration: ${(vcsStatus.prorationFactor * 100).toFixed(1)}%</div>` : ''}
                        </div>
                    `;
                }
            }
            
            // ============================================
            // EVENT HANDLERS
            // ============================================
            
            attachGlobalEventListeners() {
                // Auto-save every 30 seconds
                setInterval(() => this.saveData(), 30000);
                
                // Reposition connection bars on window resize
                window.addEventListener('resize', () => {
                    if (this.resizeTimeout) clearTimeout(this.resizeTimeout);
                    this.resizeTimeout = setTimeout(() => this.positionConnectionBars(), 100);
                });
            }
            
            attachPanningEvents() {
                const viewport = document.getElementById('org-viewport');
                const chart = document.getElementById('org-chart');
                if (!viewport || !chart) return;
                
                let startX, startY, scrollLeft, scrollTop;
                
                viewport.addEventListener('mousedown', (e) => {
                    // Don't pan if clicking on a node or button
                    if (e.target.closest('.org-node') || e.target.closest('.org-node-btn')) return;
                    
                    this.state.isPanning = true;
                    viewport.style.cursor = 'grabbing';
                    startX = e.pageX - viewport.offsetLeft;
                    startY = e.pageY - viewport.offsetTop;
                    scrollLeft = viewport.scrollLeft;
                    scrollTop = viewport.scrollTop;
                });
                
                viewport.addEventListener('mouseleave', () => {
                    this.state.isPanning = false;
                    viewport.style.cursor = 'grab';
                });
                
                viewport.addEventListener('mouseup', () => {
                    this.state.isPanning = false;
                    viewport.style.cursor = 'grab';
                });
                
                viewport.addEventListener('mousemove', (e) => {
                    if (!this.state.isPanning) return;
                    e.preventDefault();
                    const x = e.pageX - viewport.offsetLeft;
                    const y = e.pageY - viewport.offsetTop;
                    const walkX = (x - startX) * 1.5;
                    const walkY = (y - startY) * 1.5;
                    viewport.scrollLeft = scrollLeft - walkX;
                    viewport.scrollTop = scrollTop - walkY;
                });
            }
            
            resetPan() {
                const viewport = document.getElementById('org-viewport');
                const chart = document.getElementById('org-chart');
                if (!viewport || !chart) return;
                
                // Reset zoom to 1
                this.state.zoomLevel = 1;
                this.applyZoom();
                
                // Wait for reflow then center the root node at top
                requestAnimationFrame(() => {
                    const rootNode = chart.querySelector('.org-node-wrapper[data-node-id="root"] .org-node');
                    if (rootNode) {
                        const viewportRect = viewport.getBoundingClientRect();
                        const rootRect = rootNode.getBoundingClientRect();
                        const chartRect = chart.getBoundingClientRect();
                        
                        // Calculate where root is relative to chart
                        const rootCenterX = rootRect.left - chartRect.left + rootRect.width / 2;
                        
                        // Scroll to center root horizontally and show at top with some padding
                        viewport.scrollLeft = rootCenterX - viewportRect.width / 2;
                        viewport.scrollTop = 0;
                    } else {
                        // Fallback: just scroll to top-left
                        viewport.scrollLeft = 0;
                        viewport.scrollTop = 0;
                    }
                    
                    // Reposition connection bars
                    this.positionConnectionBars();
                });
            }
            
            resetOrganization() {
                if (!confirm('Are you sure you want to reset the organization? This will clear all IBOs except "You" and cannot be undone.')) {
                    return;
                }
                
                // Create fresh organization with just root
                this.state.organization = new Map();
                this.state.organization.set('root', {
                    id: 'root',
                    name: 'You',
                    pv: 0,
                    bv: 0,
                    customerSalesPV: 0,
                    vcsPV: 0,
                    notes: '',
                    children: [],
                    parentId: null
                });
                
                // Reset related state
                this.state.selectedNode = null;
                this.state.collapsedNodes = new Set();
                this.state.zoomLevel = 1;
                
                // Clear monthly data except current month structure
                const currentMonth = this.state.currentMonth;
                this.state.monthlyData = new Map();
                this.state.monthlyData.set(currentMonth, {
                    organization: JSON.parse(JSON.stringify(Array.from(this.state.organization.entries())))
                });
                
                // Save and re-render
                this.saveOrganization();
                this.renderOrganizationChart();
                this.updateIncomeSummary();
                this.updateTeamStats();
                this.resetPan();
            }
            
            // ============================================
            // INCOME PERSPECTIVE CONTROLS
            // ============================================
            
            /**
             * Switch income view to show from a specific IBO's perspective
             */
            setIncomePerspective(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node) {
                    console.warn('Node not found for perspective:', nodeId);
                    return;
                }
                
                this.state.incomePerspectiveNode = nodeId;
                this.renderOrganizationChart(); // Re-render to update button highlights
                this.updateIncomeSummary();
                this.updateIncomePerspectiveIndicator();
            }
            
            /**
             * Reset income view back to your (root) perspective
             */
            resetIncomePerspective() {
                this.state.incomePerspectiveNode = 'root';
                this.renderOrganizationChart(); // Re-render to update button highlights
                this.updateIncomeSummary();
                this.updateIncomePerspectiveIndicator();
            }
            
            /**
             * Update the income perspective indicator in the UI
             */
            updateIncomePerspectiveIndicator() {
                const indicator = document.getElementById('income-perspective-indicator');
                const controls = document.getElementById('income-perspective-controls');
                const perspectiveNode = this.state.organization.get(this.state.incomePerspectiveNode);
                
                if (indicator && perspectiveNode) {
                    const isRoot = this.state.incomePerspectiveNode === 'root';
                    indicator.textContent = isRoot ? 'Your Income' : `Viewing: ${perspectiveNode.name}`;
                    indicator.className = `text-xs px-2 py-1 rounded ${isRoot ? 'bg-white bg-opacity-20' : 'bg-yellow-400 text-yellow-900 font-bold'}`;
                }
                
                if (controls) {
                    controls.className = this.state.incomePerspectiveNode === 'root' ? 'hidden mb-3' : 'mb-3';
                }
            }
            
            attachVisualBuilderEvents() {
                // Member PV input - auto-calculate BV
                const pvInput = document.getElementById('member-pv');
                if (pvInput) {
                    pvInput.addEventListener('input', (e) => {
                        const pv = parseFloat(e.target.value) || 0;
                        const bv = pv * this.config.pvToBvRatio;
                        const bvInput = document.getElementById('member-bv');
                        if (bvInput) bvInput.value = bv.toFixed(2);
                        
                        // Auto-calculate VCS values (70% and 60% defaults)
                        const customerSalesInput = document.getElementById('customer-sales-pv');
                        const vcsInput = document.getElementById('vcs-pv');
                        if (customerSalesInput && !customerSalesInput.value) {
                            customerSalesInput.value = (pv * 0.7).toFixed(0);
                        }
                        if (vcsInput && !vcsInput.value) {
                            vcsInput.value = (pv * 0.6).toFixed(0);
                        }
                        
                        this.updateVCSStatus();
                    });
                }
                
                // VCS inputs
                ['customer-sales-pv', 'vcs-pv'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', () => this.updateVCSStatus());
                    }
                });
            }
            
            attachMultiMonthEvents() {
                // Add any multi-month specific event listeners here
            }
            
            // ============================================
            // USER ACTIONS
            // ============================================
            
            selectNode(nodeId) {
                const node = this.state.organization.get(nodeId);
                
                if (!node) {
                    console.warn('Node not found:', nodeId);
                    this.state.selectedNode = null;
                    // Clear form inputs
                    const nameInput = document.getElementById('member-name');
                    const pvInput = document.getElementById('member-pv');
                    const bvInput = document.getElementById('member-bv');
                    const customerSalesInput = document.getElementById('customer-sales-pv');
                    const vcsInput = document.getElementById('vcs-pv');
                    const notesInput = document.getElementById('member-notes');
                    
                    if (nameInput) nameInput.value = '';
                    if (pvInput) pvInput.value = '';
                    if (bvInput) bvInput.value = '';
                    if (customerSalesInput) customerSalesInput.value = '';
                    if (vcsInput) vcsInput.value = '';
                    if (notesInput) notesInput.value = '';
                    return;
                }
                
                this.state.selectedNode = nodeId;
                
                const nameInput = document.getElementById('member-name');
                const pvInput = document.getElementById('member-pv');
                const bvInput = document.getElementById('member-bv');
                const customerSalesInput = document.getElementById('customer-sales-pv');
                const vcsInput = document.getElementById('vcs-pv');
                const notesInput = document.getElementById('member-notes');
                
                if (nameInput) nameInput.value = node.name;
                if (pvInput) pvInput.value = node.pv;
                if (bvInput) bvInput.value = node.bv.toFixed(2);
                if (customerSalesInput) customerSalesInput.value = node.customerSalesPV || (node.pv * 0.7).toFixed(0);
                if (vcsInput) vcsInput.value = node.vcsPV || (node.pv * 0.6).toFixed(0);
                if (notesInput) notesInput.value = node.notes || '';
                
                this.updateVCSStatus();
                
                this.renderOrganizationChart();
            }
            
            saveMember() {
                if (!this.state.selectedNode) {
                    alert('Please select a member first');
                    return;
                }
                
                const node = this.state.organization.get(this.state.selectedNode);
                if (!node) {
                    alert('Selected member not found');
                    return;
                }
                
                const nameInput = document.getElementById('member-name');
                const pvInput = document.getElementById('member-pv');
                const customerSalesInput = document.getElementById('customer-sales-pv');
                const vcsInput = document.getElementById('vcs-pv');
                const notesInput = document.getElementById('member-notes');
                
                // Validate and sanitize inputs
                if (nameInput) {
                    const name = nameInput.value.trim();
                    node.name = name || node.name;
                }
                
                if (pvInput) {
                    const pv = Math.max(0, parseFloat(pvInput.value) || 0);
                    node.pv = pv;
                    node.bv = pv * this.config.pvToBvRatio;
                    pvInput.value = pv; // Update with sanitized value
                }
                
                if (customerSalesInput) {
                    const customerSalesPV = Math.max(0, Math.min(node.pv, parseFloat(customerSalesInput.value) || 0));
                    node.customerSalesPV = customerSalesPV;
                    customerSalesInput.value = customerSalesPV; // Update with sanitized value
                }
                
                if (vcsInput) {
                    const vcsPV = Math.max(0, Math.min(node.pv, parseFloat(vcsInput.value) || 0));
                    node.vcsPV = vcsPV;
                    vcsInput.value = vcsPV; // Update with sanitized value
                }
                
                // Save notes
                if (notesInput) {
                    node.notes = notesInput.value.trim();
                }
                
                // Update vcsCompliant property based on calculation
                const vcsStatus = this.checkVCSCompliance(node);
                node.vcsCompliant = vcsStatus.compliant;
                
                this.updateVCSStatus();
                this.renderOrganizationChart();
                this.saveData();
            }
            
            addDownline() {
                if (!this.state.selectedNode) {
                    alert('Please select a member first');
                    return;
                }
                
                this.addDownlineToNode(this.state.selectedNode);
            }
            
            addDownlineToNode(parentId) {
                const parent = this.state.organization.get(parentId);
                if (!parent) return;
                
                const newId = `node_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const newNode = {
                    id: newId,
                    name: 'New IBO',
                    pv: 100,
                    bv: 100 * this.config.pvToBvRatio,
                    customerSalesPV: 70,
                    vcsPV: 60,
                    vcsCompliant: true,
                    children: [],
                    parent: parentId,
                    level: parent.level + 1,
                    registrationDate: new Date().toISOString(),
                    notes: '' // Member notes/comments
                };
                
                this.state.organization.set(newId, newNode);
                if (!parent.children) parent.children = [];
                parent.children.push(newId);
                
                this.selectNode(newId);
                this.renderOrganizationChart();
                this.saveData();
            }
            
            loadExampleStructure(type) {
                if (!type) return;
                
                if (!confirm(`This will replace your current organization structure with the ${type.toUpperCase().replace(/_/g, ' ')} example. Continue?`)) {
                    document.getElementById('example-selector').value = '';
                    return;
                }
                
                // Clear existing organization
                this.state.organization.clear();
                this.state.selectedNode = null;
                
                // Get example structure
                const structure = this.getExampleStructure(type);
                
                // Build the organization from the structure
                this.buildOrganizationFromStructure(structure);
                
                // Reset selector
                document.getElementById('example-selector').value = '';
                
                this.renderOrganizationChart();
                this.saveData();
                
                // Auto fit after loading
                setTimeout(() => this.autoFit(), 200);
            }
            
            getExampleStructure(type) {
                // All IBOs do 150 PV each per BWW 9 Core Steps
                const PV = 150;
                
                const structures = {
                    // ========================================
                    // BWW SYR LEVELS
                    // ========================================
                    
                    // BFI-T5 - Team of 5 (BWW SYR)
                    bfi_t5: {
                        name: 'You', pv: PV, children: [
                            { name: 'IBO 1', pv: PV },
                            { name: 'IBO 2', pv: PV },
                            { name: 'IBO 3', pv: PV },
                            { name: 'IBO 4', pv: PV }
                        ]
                    },
                    
                    // BBI-T10 - Team of 10 (BWW SYR)
                    bbi_t10: {
                        name: 'You', pv: PV, children: [
                            { name: 'Leg 1', pv: PV, children: [
                                { name: 'IBO 1a', pv: PV },
                                { name: 'IBO 1b', pv: PV }
                            ]},
                            { name: 'Leg 2', pv: PV, children: [
                                { name: 'IBO 2a', pv: PV },
                                { name: 'IBO 2b', pv: PV }
                            ]},
                            { name: 'Leg 3', pv: PV, children: [
                                { name: 'IBO 3a', pv: PV }
                            ]}
                        ]
                    },
                    
                    // BTS25 - Bronze to Silver 25 (4 legs, 25 people, ~4000 PV)
                    bts25: {
                        name: 'You', pv: PV, children: this.generateBTS25Legs()
                    },
                    
                    // EP40 - Eagle Platinum 40 (6 legs, 40 people, 7500 PV)
                    ep40: {
                        name: 'You', pv: PV, children: this.generateEP40Legs()
                    },
                    
                    // EPR75 - Eagle Plus Ruby 75 (9 legs, 75 people, 15000 PV)
                    epr75: {
                        name: 'You', pv: PV, children: this.generateEPR75Legs()
                    },
                    
                    // ========================================
                    // AMWAY PRODUCER LEVELS
                    // ========================================
                    
                    // Silver Producer - 7,500 PV = 50 IBOs @ 150 PV each
                    silver: {
                        name: 'You', pv: PV, children: this.generateSilverLegs()
                    },
                    
                    // Gold Producer - Same as Silver (achieved 3 months)
                    gold: {
                        name: 'You (Gold)', pv: PV, children: this.generateSilverLegs()
                    },
                    
                    // Platinum - 7,500 PV for 6 months (~50 IBOs)
                    platinum: {
                        name: 'You', pv: PV, children: this.generatePlatinumLegs()
                    },
                    
                    // Founders Platinum - Silver for 12 months
                    founders_platinum: {
                        name: 'You (FP)', pv: PV, children: this.generatePlatinumLegs()
                    },
                    
                    // ========================================
                    // AMWAY PIN LEVELS
                    // ========================================
                    
                    // Ruby - 15,000 PV = ~100 IBOs @ 150 PV each
                    ruby: {
                        name: 'You', pv: PV, children: this.generateRubyLegs()
                    },
                    
                    // Sapphire - 2-3 legs at 25% for 6 months (~150 IBOs)
                    sapphire: {
                        name: 'You', pv: PV, children: this.generateSapphireLegs()
                    },
                    
                    // Emerald - 3 legs at 25% for 6 months (~200 IBOs)
                    emerald: {
                        name: 'You', pv: PV, children: this.generateEmeraldLegs()
                    },
                    
                    // Diamond - 6 legs at 25% for 6 months (~300 IBOs)
                    diamond: {
                        name: 'You', pv: PV, children: this.generateDiamondLegs(6)
                    },
                    
                    // ========================================
                    // EXECUTIVE LEVELS (Based on FP Groups)
                    // ========================================
                    
                    // Executive Diamond - 6 Founders Platinum groups
                    executive_diamond: {
                        name: 'You (ED)', pv: PV, children: this.generateDiamondLegs(6, true)
                    },
                    
                    // Double Diamond - 8 Founders Platinum groups
                    double_diamond: {
                        name: 'You (DD)', pv: PV, children: this.generateDiamondLegs(8, true)
                    },
                    
                    // Triple Diamond - 10 Founders Platinum groups
                    triple_diamond: {
                        name: 'You (TD)', pv: PV, children: this.generateDiamondLegs(10, true)
                    },
                    
                    // Crown - 12 Founders Platinum groups
                    crown: {
                        name: 'You (Crown)', pv: PV, children: this.generateDiamondLegs(12, true)
                    },
                    
                    // Crown Ambassador - 14 Founders Platinum groups
                    crown_ambassador: {
                        name: 'You (CA)', pv: PV, children: this.generateDiamondLegs(14, true)
                    },
                    
                    // Founders Crown Ambassador - 14+ FP groups
                    founders_crown_ambassador: {
                        name: 'You (FCA)', pv: PV, children: this.generateDiamondLegs(14, true)
                    }
                };
                
                return structures[type] || structures.bfi_t5;
            }
            
            // BTS25 - Bronze to Silver 25: 4 legs, 25 people total
            // 25 IBOs Ã— 150 PV = 3,750 PV (approaching 4,000 PV Silver threshold)
            generateBTS25Legs() {
                const PV = 150;
                // Target: 24 downline + You = 25 total
                return [
                    // Leg 1: 7 IBOs
                    { name: 'Leg 1', pv: PV, children: [
                        { name: 'L1-A', pv: PV, children: [
                            { name: 'L1-A1', pv: PV },
                            { name: 'L1-A2', pv: PV }
                        ]},
                        { name: 'L1-B', pv: PV, children: [
                            { name: 'L1-B1', pv: PV },
                            { name: 'L1-B2', pv: PV }
                        ]}
                    ]},
                    // Leg 2: 7 IBOs
                    { name: 'Leg 2', pv: PV, children: [
                        { name: 'L2-A', pv: PV, children: [
                            { name: 'L2-A1', pv: PV },
                            { name: 'L2-A2', pv: PV }
                        ]},
                        { name: 'L2-B', pv: PV, children: [
                            { name: 'L2-B1', pv: PV },
                            { name: 'L2-B2', pv: PV }
                        ]}
                    ]},
                    // Leg 3: 5 IBOs
                    { name: 'Leg 3', pv: PV, children: [
                        { name: 'L3-A', pv: PV, children: [
                            { name: 'L3-A1', pv: PV }
                        ]},
                        { name: 'L3-B', pv: PV, children: [
                            { name: 'L3-B1', pv: PV }
                        ]}
                    ]},
                    // Leg 4: 5 IBOs
                    { name: 'Leg 4', pv: PV, children: [
                        { name: 'L4-A', pv: PV, children: [
                            { name: 'L4-A1', pv: PV }
                        ]},
                        { name: 'L4-B', pv: PV, children: [
                            { name: 'L4-B1', pv: PV }
                        ]}
                    ]}
                ];
                // Total: 7+7+5+5 = 24 downline + You = 25 IBOs Ã— 150 PV = 3,750 PV âœ“
            }
            
            // EP40 - Eagle Platinum 40: 6 legs, 40 people total
            // 40 IBOs Ã— 150 PV = 6,000 PV (EP structure teaches path to Platinum)
            generateEP40Legs() {
                const PV = 150;
                // Target: 39 downline + You = 40 total
                return [
                    // Leg 1: 8 IBOs
                    { name: 'Leg 1', pv: PV, children: [
                        { name: 'L1-A', pv: PV, children: [
                            { name: 'L1-A1', pv: PV },
                            { name: 'L1-A2', pv: PV },
                            { name: 'L1-A3', pv: PV }
                        ]},
                        { name: 'L1-B', pv: PV, children: [
                            { name: 'L1-B1', pv: PV },
                            { name: 'L1-B2', pv: PV }
                        ]}
                    ]},
                    // Leg 2: 8 IBOs
                    { name: 'Leg 2', pv: PV, children: [
                        { name: 'L2-A', pv: PV, children: [
                            { name: 'L2-A1', pv: PV },
                            { name: 'L2-A2', pv: PV },
                            { name: 'L2-A3', pv: PV }
                        ]},
                        { name: 'L2-B', pv: PV, children: [
                            { name: 'L2-B1', pv: PV },
                            { name: 'L2-B2', pv: PV }
                        ]}
                    ]},
                    // Leg 3: 7 IBOs
                    { name: 'Leg 3', pv: PV, children: [
                        { name: 'L3-A', pv: PV, children: [
                            { name: 'L3-A1', pv: PV },
                            { name: 'L3-A2', pv: PV }
                        ]},
                        { name: 'L3-B', pv: PV, children: [
                            { name: 'L3-B1', pv: PV },
                            { name: 'L3-B2', pv: PV }
                        ]}
                    ]},
                    // Leg 4: 6 IBOs
                    { name: 'Leg 4', pv: PV, children: [
                        { name: 'L4-A', pv: PV, children: [
                            { name: 'L4-A1', pv: PV },
                            { name: 'L4-A2', pv: PV }
                        ]},
                        { name: 'L4-B', pv: PV, children: [
                            { name: 'L4-B1', pv: PV }
                        ]}
                    ]},
                    // Leg 5: 5 IBOs
                    { name: 'Leg 5', pv: PV, children: [
                        { name: 'L5-A', pv: PV, children: [
                            { name: 'L5-A1', pv: PV }
                        ]},
                        { name: 'L5-B', pv: PV, children: [
                            { name: 'L5-B1', pv: PV }
                        ]}
                    ]},
                    // Leg 6: 5 IBOs
                    { name: 'Leg 6', pv: PV, children: [
                        { name: 'L6-A', pv: PV, children: [
                            { name: 'L6-A1', pv: PV }
                        ]},
                        { name: 'L6-B', pv: PV, children: [
                            { name: 'L6-B1', pv: PV }
                        ]}
                    ]}
                ];
                // Total: 8+8+7+6+5+5 = 39 downline + You = 40 IBOs Ã— 150 PV = 6,000 PV âœ“
            }
            
            // EPR75 - Eagle Plus Ruby 75: 9 legs, 75 people total
            // 75 IBOs Ã— 150 PV = 11,250 PV (approaching Ruby 15,000 PV)
            generateEPR75Legs() {
                const PV = 150;
                // Target: 74 downline + You = 75 total
                // Structure: 1 EP40 leg (39 people) + 8 smaller legs (35 people)
                return [
                    // Main EP40 Leg: 39 IBOs
                    { name: 'EP40 Leg', pv: PV, children: this.generateEP40Legs() },
                    // Leg 2: 5 IBOs
                    { name: 'Leg 2', pv: PV, children: [
                        { name: 'L2-A', pv: PV, children: [{ name: 'L2-A1', pv: PV }] },
                        { name: 'L2-B', pv: PV, children: [{ name: 'L2-B1', pv: PV }] }
                    ]},
                    // Leg 3: 5 IBOs
                    { name: 'Leg 3', pv: PV, children: [
                        { name: 'L3-A', pv: PV, children: [{ name: 'L3-A1', pv: PV }] },
                        { name: 'L3-B', pv: PV, children: [{ name: 'L3-B1', pv: PV }] }
                    ]},
                    // Leg 4: 5 IBOs
                    { name: 'Leg 4', pv: PV, children: [
                        { name: 'L4-A', pv: PV, children: [{ name: 'L4-A1', pv: PV }] },
                        { name: 'L4-B', pv: PV, children: [{ name: 'L4-B1', pv: PV }] }
                    ]},
                    // Leg 5: 4 IBOs
                    { name: 'Leg 5', pv: PV, children: [
                        { name: 'L5-A', pv: PV, children: [{ name: 'L5-A1', pv: PV }] },
                        { name: 'L5-B', pv: PV }
                    ]},
                    // Leg 6: 4 IBOs
                    { name: 'Leg 6', pv: PV, children: [
                        { name: 'L6-A', pv: PV, children: [{ name: 'L6-A1', pv: PV }] },
                        { name: 'L6-B', pv: PV }
                    ]},
                    // Leg 7: 4 IBOs
                    { name: 'Leg 7', pv: PV, children: [
                        { name: 'L7-A', pv: PV, children: [{ name: 'L7-A1', pv: PV }] },
                        { name: 'L7-B', pv: PV }
                    ]},
                    // Leg 8: 4 IBOs
                    { name: 'Leg 8', pv: PV, children: [
                        { name: 'L8-A', pv: PV, children: [{ name: 'L8-A1', pv: PV }] },
                        { name: 'L8-B', pv: PV }
                    ]},
                    // Leg 9: 4 IBOs
                    { name: 'Leg 9', pv: PV, children: [
                        { name: 'L9-A', pv: PV, children: [{ name: 'L9-A1', pv: PV }] },
                        { name: 'L9-B', pv: PV }
                    ]}
                ];
                // Total: 39 + 5+5+5+4+4+4+4+4 = 74 downline + You = 75 IBOs Ã— 150 PV = 11,250 PV âœ“
            }
            
            // Silver/Platinum - 7,500 PV = 50 IBOs @ 150 PV each
            // Structure: 6 legs with 49 downline + You = 50 IBOs total
            generateSilverLegs() {
                const PV = 150;
                // Target: 49 downline IBOs (You + 49 = 50 total = 7,500 PV)
                // Each leg averages ~8 IBOs
                return [
                    // Leg 1: 9 IBOs
                    { name: 'Leg 1', pv: PV, children: [
                        { name: 'L1-A', pv: PV, children: [
                            { name: 'L1-A1', pv: PV },
                            { name: 'L1-A2', pv: PV },
                            { name: 'L1-A3', pv: PV }
                        ]},
                        { name: 'L1-B', pv: PV, children: [
                            { name: 'L1-B1', pv: PV },
                            { name: 'L1-B2', pv: PV },
                            { name: 'L1-B3', pv: PV }
                        ]}
                    ]},
                    // Leg 2: 9 IBOs
                    { name: 'Leg 2', pv: PV, children: [
                        { name: 'L2-A', pv: PV, children: [
                            { name: 'L2-A1', pv: PV },
                            { name: 'L2-A2', pv: PV },
                            { name: 'L2-A3', pv: PV }
                        ]},
                        { name: 'L2-B', pv: PV, children: [
                            { name: 'L2-B1', pv: PV },
                            { name: 'L2-B2', pv: PV },
                            { name: 'L2-B3', pv: PV }
                        ]}
                    ]},
                    // Leg 3: 8 IBOs
                    { name: 'Leg 3', pv: PV, children: [
                        { name: 'L3-A', pv: PV, children: [
                            { name: 'L3-A1', pv: PV },
                            { name: 'L3-A2', pv: PV },
                            { name: 'L3-A3', pv: PV }
                        ]},
                        { name: 'L3-B', pv: PV, children: [
                            { name: 'L3-B1', pv: PV },
                            { name: 'L3-B2', pv: PV }
                        ]}
                    ]},
                    // Leg 4: 8 IBOs
                    { name: 'Leg 4', pv: PV, children: [
                        { name: 'L4-A', pv: PV, children: [
                            { name: 'L4-A1', pv: PV },
                            { name: 'L4-A2', pv: PV },
                            { name: 'L4-A3', pv: PV }
                        ]},
                        { name: 'L4-B', pv: PV, children: [
                            { name: 'L4-B1', pv: PV },
                            { name: 'L4-B2', pv: PV }
                        ]}
                    ]},
                    // Leg 5: 8 IBOs
                    { name: 'Leg 5', pv: PV, children: [
                        { name: 'L5-A', pv: PV, children: [
                            { name: 'L5-A1', pv: PV },
                            { name: 'L5-A2', pv: PV }
                        ]},
                        { name: 'L5-B', pv: PV, children: [
                            { name: 'L5-B1', pv: PV },
                            { name: 'L5-B2', pv: PV },
                            { name: 'L5-B3', pv: PV }
                        ]}
                    ]},
                    // Leg 6: 7 IBOs
                    { name: 'Leg 6', pv: PV, children: [
                        { name: 'L6-A', pv: PV, children: [
                            { name: 'L6-A1', pv: PV },
                            { name: 'L6-A2', pv: PV }
                        ]},
                        { name: 'L6-B', pv: PV, children: [
                            { name: 'L6-B1', pv: PV },
                            { name: 'L6-B2', pv: PV }
                        ]}
                    ]}
                ];
                // Total: 9+9+8+8+8+7 = 49 downline + You = 50 IBOs Ã— 150 PV = 7,500 PV âœ“
            }
            
            // Platinum - Same as Silver structure (Platinum = Silver for 6 months)
            generatePlatinumLegs() {
                return this.generateSilverLegs();
            }
            
            // Ruby - 15,000+ PV with NO legs at 7,500 PV or more
            // Multiple smaller organizations all under 7,500 PV each
            // 100 IBOs Ã— 150 PV = 15,000 PV spread across many legs
            generateRubyLegs() {
                const PV = 150;
                // 8 legs, each under 7,500 PV (under 50 IBOs each)
                // Total: ~99 downline + You = 100 IBOs = 15,000 PV
                return [
                    // Leg 1: 15 IBOs (2,250 PV - under 7,500)
                    { name: 'Leg 1', pv: PV, children: [
                        { name: 'L1-A', pv: PV, children: [
                            { name: 'L1-A1', pv: PV, children: [{ name: 'L1-A1a', pv: PV }] },
                            { name: 'L1-A2', pv: PV, children: [{ name: 'L1-A2a', pv: PV }] }
                        ]},
                        { name: 'L1-B', pv: PV, children: [
                            { name: 'L1-B1', pv: PV, children: [{ name: 'L1-B1a', pv: PV }] },
                            { name: 'L1-B2', pv: PV, children: [{ name: 'L1-B2a', pv: PV }] }
                        ]},
                        { name: 'L1-C', pv: PV, children: [
                            { name: 'L1-C1', pv: PV }
                        ]}
                    ]},
                    // Leg 2: 15 IBOs (2,250 PV)
                    { name: 'Leg 2', pv: PV, children: [
                        { name: 'L2-A', pv: PV, children: [
                            { name: 'L2-A1', pv: PV, children: [{ name: 'L2-A1a', pv: PV }] },
                            { name: 'L2-A2', pv: PV, children: [{ name: 'L2-A2a', pv: PV }] }
                        ]},
                        { name: 'L2-B', pv: PV, children: [
                            { name: 'L2-B1', pv: PV, children: [{ name: 'L2-B1a', pv: PV }] },
                            { name: 'L2-B2', pv: PV, children: [{ name: 'L2-B2a', pv: PV }] }
                        ]},
                        { name: 'L2-C', pv: PV, children: [
                            { name: 'L2-C1', pv: PV }
                        ]}
                    ]},
                    // Leg 3: 14 IBOs (2,100 PV)
                    { name: 'Leg 3', pv: PV, children: [
                        { name: 'L3-A', pv: PV, children: [
                            { name: 'L3-A1', pv: PV, children: [{ name: 'L3-A1a', pv: PV }] },
                            { name: 'L3-A2', pv: PV }
                        ]},
                        { name: 'L3-B', pv: PV, children: [
                            { name: 'L3-B1', pv: PV, children: [{ name: 'L3-B1a', pv: PV }] },
                            { name: 'L3-B2', pv: PV }
                        ]},
                        { name: 'L3-C', pv: PV, children: [
                            { name: 'L3-C1', pv: PV }
                        ]}
                    ]},
                    // Leg 4: 14 IBOs (2,100 PV)
                    { name: 'Leg 4', pv: PV, children: [
                        { name: 'L4-A', pv: PV, children: [
                            { name: 'L4-A1', pv: PV, children: [{ name: 'L4-A1a', pv: PV }] },
                            { name: 'L4-A2', pv: PV }
                        ]},
                        { name: 'L4-B', pv: PV, children: [
                            { name: 'L4-B1', pv: PV, children: [{ name: 'L4-B1a', pv: PV }] },
                            { name: 'L4-B2', pv: PV }
                        ]},
                        { name: 'L4-C', pv: PV, children: [
                            { name: 'L4-C1', pv: PV }
                        ]}
                    ]},
                    // Leg 5: 12 IBOs (1,800 PV)
                    { name: 'Leg 5', pv: PV, children: [
                        { name: 'L5-A', pv: PV, children: [
                            { name: 'L5-A1', pv: PV },
                            { name: 'L5-A2', pv: PV }
                        ]},
                        { name: 'L5-B', pv: PV, children: [
                            { name: 'L5-B1', pv: PV },
                            { name: 'L5-B2', pv: PV }
                        ]},
                        { name: 'L5-C', pv: PV, children: [
                            { name: 'L5-C1', pv: PV }
                        ]}
                    ]},
                    // Leg 6: 10 IBOs (1,500 PV)
                    { name: 'Leg 6', pv: PV, children: [
                        { name: 'L6-A', pv: PV, children: [
                            { name: 'L6-A1', pv: PV },
                            { name: 'L6-A2', pv: PV }
                        ]},
                        { name: 'L6-B', pv: PV, children: [
                            { name: 'L6-B1', pv: PV },
                            { name: 'L6-B2', pv: PV }
                        ]}
                    ]},
                    // Leg 7: 10 IBOs (1,500 PV)
                    { name: 'Leg 7', pv: PV, children: [
                        { name: 'L7-A', pv: PV, children: [
                            { name: 'L7-A1', pv: PV },
                            { name: 'L7-A2', pv: PV }
                        ]},
                        { name: 'L7-B', pv: PV, children: [
                            { name: 'L7-B1', pv: PV },
                            { name: 'L7-B2', pv: PV }
                        ]}
                    ]},
                    // Leg 8: 9 IBOs (1,350 PV)
                    { name: 'Leg 8', pv: PV, children: [
                        { name: 'L8-A', pv: PV, children: [
                            { name: 'L8-A1', pv: PV },
                            { name: 'L8-A2', pv: PV }
                        ]},
                        { name: 'L8-B', pv: PV, children: [
                            { name: 'L8-B1', pv: PV }
                        ]}
                    ]}
                ];
                // Total: 15+15+14+14+12+10+10+9 = 99 downline + You = 100 IBOs Ã— 150 PV = 15,000 PV âœ“
                // Each leg is under 7,500 PV (largest is 2,250 PV) âœ“
            }
            
            // Sapphire - 2 legs at 7,500+ PV (25% level) for 6 months
            // Each 25% leg needs 7,500 PV = 50 IBOs
            // Total: ~102 IBOs = 15,300 PV (2 qualified legs)
            generateSapphireLegs() {
                const PV = 150;
                return [
                    { name: '25% Leg 1 (7,500 PV)', pv: PV, children: this.generateSilverLegs() },
                    { name: '25% Leg 2 (7,500 PV)', pv: PV, children: this.generateSilverLegs() }
                ];
                // Total: 2 Ã— 50 = 100 downline + 2 leg heads + You â‰ˆ 102 IBOs Ã— 150 PV â‰ˆ 15,300 PV âœ“
                // Both legs at 7,500+ PV (25% level) âœ“
            }
            
            // Emerald - Platinum + 3 legs at 25% for 6 months
            // You must be at Platinum level AND have 3 legs at 25%
            // ~153 IBOs = 22,950 PV
            generateEmeraldLegs() {
                const PV = 150;
                return [
                    { name: '25% Leg 1 (7,500 PV)', pv: PV, children: this.generateSilverLegs() },
                    { name: '25% Leg 2 (7,500 PV)', pv: PV, children: this.generateSilverLegs() },
                    { name: '25% Leg 3 (7,500 PV)', pv: PV, children: this.generateSilverLegs() }
                ];
                // Total: 3 Ã— 50 = 150 downline + 3 leg heads + You â‰ˆ 153 IBOs Ã— 150 PV â‰ˆ 22,950 PV âœ“
                // 3 legs at 25% level âœ“
            }
            
            // Diamond and above - 6+ legs at 25% for 6 months
            // Each leg is a full Platinum group (50 IBOs, 7,500 PV)
            generateDiamondLegs(numLegs, isFoundersPlatinum = false) {
                const PV = 150;
                const legs = [];
                
                for (let i = 1; i <= numLegs; i++) {
                    legs.push({
                        name: `${isFoundersPlatinum ? 'FP' : 'Platinum'} ${i}`,
                        pv: PV,
                        children: this.generateSilverLegs()
                    });
                }
                
                return legs;
                // Diamond (6 legs): 6 Ã— 50 = 300 IBOs Ã— 150 PV = 45,000 PV âœ“
                // Executive Diamond (6 FP legs): 6 Ã— 50 = 300 IBOs Ã— 150 PV = 45,000 PV âœ“
                // Double Diamond (8 FP legs): 8 Ã— 50 = 400 IBOs Ã— 150 PV = 60,000 PV âœ“
                // Triple Diamond (10 FP legs): 10 Ã— 50 = 500 IBOs Ã— 150 PV = 75,000 PV âœ“
                // Crown (12 FP legs): 12 Ã— 50 = 600 IBOs Ã— 150 PV = 90,000 PV âœ“
                // Crown Ambassador (14 FP legs): 14 Ã— 50 = 700 IBOs Ã— 150 PV = 105,000 PV âœ“
            }
            
            buildOrganizationFromStructure(structure, parentId = null, level = 0) {
                const nodeId = parentId === null ? 'root' : `node_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const node = {
                    id: nodeId,
                    name: structure.name,
                    pv: structure.pv,
                    bv: structure.pv * this.config.pvToBvRatio,
                    customerSalesPV: structure.pv * 0.7,
                    vcsPV: structure.pv * 0.6,
                    vcsCompliant: true,
                    children: [],
                    parent: parentId,
                    level: level,
                    registrationDate: new Date().toISOString(),
                    notes: ''
                };
                
                this.state.organization.set(nodeId, node);
                
                if (structure.children && structure.children.length > 0) {
                    structure.children.forEach(childStructure => {
                        const childId = this.buildOrganizationFromStructure(childStructure, nodeId, level + 1);
                        node.children.push(childId);
                    });
                }
                
                return nodeId;
            }
            
            deleteMember(deleteChildren = false, nodeId = null) {
                const targetId = nodeId || this.state.selectedNode;
                
                if (!targetId || targetId === 'root') {
                    alert('Cannot delete root node');
                    return;
                }
                
                const node = this.state.organization.get(targetId);
                if (!node) return;
                
                const confirmMsg = deleteChildren 
                    ? `Delete ${node.name} and their entire group?`
                    : `Delete ${node.name}? Their downline will move up.`;
                
                if (!confirm(confirmMsg)) return;
                
                const parent = this.state.organization.get(node.parent);
                if (!parent) return;
                
                // Remove from parent's children
                parent.children = parent.children.filter(id => id !== targetId);
                
                if (!deleteChildren && node.children && node.children.length > 0) {
                    // Move children up to parent
                    node.children.forEach(childId => {
                        const child = this.state.organization.get(childId);
                        if (child) {
                            child.parent = parent.id;
                            child.level = node.level;
                            parent.children.push(childId);
                        }
                    });
                } else if (deleteChildren && node.children) {
                    // Recursively delete all children
                    const deleteRecursive = (id) => {
                        const n = this.state.organization.get(id);
                        if (n && n.children) {
                            n.children.forEach(childId => deleteRecursive(childId));
                        }
                        this.state.organization.delete(id);
                    };
                    
                    node.children.forEach(childId => deleteRecursive(childId));
                }
                
                this.state.organization.delete(targetId);
                this.state.selectedNode = null;
                this.renderOrganizationChart();
                this.saveData();
            }
            
            pushToMultiMonth() {
                const currentMonth = this.state.currentMonth;
                const organizationSnapshot = new Map();
                
                // Deep clone organization
                this.state.organization.forEach((node, id) => {
                    organizationSnapshot.set(id, {
                        ...node,
                        children: node.children ? [...node.children] : []
                    });
                });
                
                const income = this.calculateIncome();
                
                this.state.monthlyData.set(currentMonth, {
                    organization: organizationSnapshot,
                    income: { ...income },
                    timestamp: new Date().toISOString()
                });
                
                this.saveData();
                alert(`Business structure pushed to ${this.formatMonth(currentMonth)}!`);
            }
            
            deleteMonthlyData(month) {
                if (!confirm(`Delete data for ${this.formatMonth(month)}? This cannot be undone.`)) {
                    return;
                }
                
                this.state.monthlyData.delete(month);
                this.saveData();
                this.renderTabContent();
            }
            
            switchTab(tabName) {
                this.state.currentTab = tabName;
                
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    }
                });
                
                this.renderTabContent();
            }
            
            toggleIncomeDetails() {
                const modal = document.getElementById('income-details-modal');
                if (!modal) return;
                
                if (modal.classList.contains('show')) {
                    modal.classList.remove('show');
                } else {
                    // Generate detailed breakdown
                    const content = document.getElementById('income-details-content');
                    if (content) {
                        content.innerHTML = this.generateDetailedIncomeBreakdown();
                    }
                    modal.classList.add('show');
                }
            }
            
            // ============================================
            // UPGRADE IBO TO STRUCTURE
            // ============================================
            
            showUpgradeModal() {
                if (!this.state.selectedNode) {
                    alert('Please select an IBO first');
                    return;
                }
                
                const node = this.state.organization.get(this.state.selectedNode);
                if (!node) {
                    alert('Selected IBO not found');
                    return;
                }
                
                // Update modal with selected IBO name
                const nameSpan = document.getElementById('upgrade-ibo-name');
                if (nameSpan) {
                    nameSpan.textContent = node.name;
                }
                
                const modal = document.getElementById('upgrade-ibo-modal');
                if (modal) {
                    modal.classList.add('show');
                }
            }
            
            hideUpgradeModal() {
                const modal = document.getElementById('upgrade-ibo-modal');
                if (modal) {
                    modal.classList.remove('show');
                }
            }
            
            applyUpgrade() {
                if (!this.state.selectedNode) {
                    alert('No IBO selected');
                    return;
                }
                
                const selectedNode = this.state.organization.get(this.state.selectedNode);
                if (!selectedNode) {
                    alert('Selected IBO not found');
                    return;
                }
                
                const structureSelect = document.getElementById('upgrade-structure-select');
                const keepNameCheckbox = document.getElementById('upgrade-keep-name');
                
                if (!structureSelect) return;
                
                const structureType = structureSelect.value;
                const keepName = keepNameCheckbox ? keepNameCheckbox.checked : true;
                
                // Get the structure template
                const structure = this.getExampleStructure(structureType);
                
                // If keeping name, update structure root name
                if (keepName) {
                    structure.name = selectedNode.name;
                }
                
                // Store existing children to preserve them
                const existingChildren = selectedNode.children ? [...selectedNode.children] : [];
                
                // Get parent info
                const parentId = selectedNode.parent;
                const nodeId = this.state.selectedNode;
                const isRoot = nodeId === 'root';
                
                if (isRoot) {
                    // If upgrading root, clear everything and rebuild
                    this.state.organization.clear();
                    this.buildOrganizationFromStructure(structure, null, 0);
                    
                    // Re-attach existing children to the deepest nodes or first available
                    if (existingChildren.length > 0) {
                        this.reattachChildren(existingChildren, 'root');
                    }
                } else {
                    // Remove the selected node from parent's children
                    const parent = this.state.organization.get(parentId);
                    if (parent) {
                        const childIndex = parent.children.indexOf(nodeId);
                        
                        // Delete the selected node and all its generated structure
                        this.deleteNodeRecursive(nodeId);
                        
                        // Build the new structure as a subtree
                        const newNodeId = this.buildOrganizationFromStructureAsSubtree(structure, parentId, selectedNode.level);
                        
                        // Insert the new node at the same position
                        if (childIndex >= 0) {
                            parent.children.splice(childIndex, 0, newNodeId);
                        } else {
                            parent.children.push(newNodeId);
                        }
                        
                        // Re-attach existing children
                        if (existingChildren.length > 0) {
                            this.reattachChildren(existingChildren, newNodeId);
                        }
                    }
                }
                
                // Close modal and refresh
                this.hideUpgradeModal();
                this.renderOrganizationChart();
                this.updateIncomeDisplay();
                this.saveData();
                
                // Show success message
                const structureNames = {
                    bfi_t5: 'BFI-T5', bbi_t10: 'BBI-T10', bts25: 'BTS25', ep40: 'EP40', epr75: 'EPR75',
                    silver: 'Silver Producer', gold: 'Gold Producer', platinum: 'Platinum', founders_platinum: 'Founders Platinum',
                    ruby: 'Ruby', sapphire: 'Sapphire', emerald: 'Emerald', diamond: 'Diamond',
                    executive_diamond: 'Executive Diamond', double_diamond: 'Double Diamond', triple_diamond: 'Triple Diamond',
                    crown: 'Crown', crown_ambassador: 'Crown Ambassador', founders_crown_ambassador: 'Founders Crown Ambassador'
                };
                
                alert(`Successfully upgraded "${structure.name}" to ${structureNames[structureType] || structureType} structure!`);
            }
            
            // Build structure as a subtree (not starting from root)
            buildOrganizationFromStructureAsSubtree(structure, parentId, startLevel) {
                const nodeId = `node_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const node = {
                    id: nodeId,
                    name: structure.name,
                    pv: structure.pv,
                    bv: structure.pv * this.config.pvToBvRatio,
                    customerSalesPV: structure.pv * 0.7,
                    vcsPV: structure.pv * 0.6,
                    vcsCompliant: true,
                    children: [],
                    parent: parentId,
                    level: startLevel,
                    registrationDate: new Date().toISOString(),
                    notes: ''
                };
                
                this.state.organization.set(nodeId, node);
                
                if (structure.children && structure.children.length > 0) {
                    structure.children.forEach(childStructure => {
                        const childId = this.buildOrganizationFromStructureAsSubtree(childStructure, nodeId, startLevel + 1);
                        node.children.push(childId);
                    });
                }
                
                return nodeId;
            }
            
            // Delete a node and all its descendants
            deleteNodeRecursive(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node) return;
                
                // First delete all children recursively
                if (node.children && node.children.length > 0) {
                    [...node.children].forEach(childId => {
                        this.deleteNodeRecursive(childId);
                    });
                }
                
                // Then delete this node
                this.state.organization.delete(nodeId);
            }
            
            // Re-attach existing children to a new parent structure
            reattachChildren(childIds, newParentId) {
                const newParent = this.state.organization.get(newParentId);
                if (!newParent) return;
                
                // Find the first "leg" node (first level children) to attach orphaned nodes
                let targetParentId = newParentId;
                
                // If the new parent has children, attach to the last child's deepest node
                if (newParent.children && newParent.children.length > 0) {
                    // Get a developing/empty leg if available, otherwise use first leg
                    const lastLegId = newParent.children[newParent.children.length - 1];
                    targetParentId = this.findDeepestLeafNode(lastLegId);
                }
                
                const targetParent = this.state.organization.get(targetParentId);
                if (!targetParent) return;
                
                // Attach each child
                childIds.forEach(childId => {
                    const child = this.state.organization.get(childId);
                    if (child) {
                        child.parent = targetParentId;
                        child.level = targetParent.level + 1;
                        if (!targetParent.children) targetParent.children = [];
                        targetParent.children.push(childId);
                        
                        // Update all descendant levels
                        this.updateDescendantLevels(childId);
                    }
                });
            }
            
            // Find the deepest leaf node in a subtree
            findDeepestLeafNode(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node) return nodeId;
                
                if (!node.children || node.children.length === 0) {
                    return nodeId;
                }
                
                // Go down the last child
                return this.findDeepestLeafNode(node.children[node.children.length - 1]);
            }
            
            // Update levels of all descendants after reattachment
            updateDescendantLevels(nodeId) {
                const node = this.state.organization.get(nodeId);
                if (!node || !node.children) return;
                
                node.children.forEach(childId => {
                    const child = this.state.organization.get(childId);
                    if (child) {
                        child.level = node.level + 1;
                        this.updateDescendantLevels(childId);
                    }
                });
            }
            
            generateDetailedIncomeBreakdown() {
                const income = this.calculateIncome();
                const root = this.state.organization.get('root');
                const yourLevel = this.getPerformanceLevel(income.totalPV);
                
                let html = `
                    <div class="space-y-6">
                        <!-- Personal Performance -->
                        <div class="border-b pb-4">
                            <h4 class="font-bold mb-3">Your Personal Performance Bonus</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Your Personal PV:</span>
                                    <span class="font-mono">${root.pv}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Your Personal BV:</span>
                                    <span class="font-mono">${root.bv.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Total Group PV:</span>
                                    <span class="font-mono">${income.totalPV.toFixed(0)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Side Volume PV:</span>
                                    <span class="font-mono">${income.rubyPV.toFixed(0)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Side Volume BV:</span>
                                    <span class="font-mono">${income.rubyBV.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Performance Level:</span>
                                    <span class="font-mono font-bold text-blue-600">${yourLevel}%</span>
                                </div>
                                <div class="flex justify-between font-bold text-green-600 pt-2 border-t">
                                    <span>Calculation: ${income.rubyBV.toFixed(2)} Ã— ${yourLevel}% =</span>
                                    <span>$${income.performanceBonus.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                `;
                
                // Differential Bonuses
                if (root.children && root.children.length > 0) {
                    html += `
                        <div class="border-b pb-4">
                            <h4 class="font-bold mb-3">Differential Bonuses (Frontline)</h4>
                            <div class="space-y-3">
                    `;
                    
                    root.children.forEach(childId => {
                        const child = this.state.organization.get(childId);
                        if (!child) return;
                        
                        const childGroupPV = this.calculateGroupPV(childId);
                        const childGroupBV = this.calculateGroupBV(childId);
                        const theirLevel = this.getPerformanceLevel(childGroupPV);
                        const differential = yourLevel - theirLevel;
                        const diffBonus = childGroupBV * (differential / 100);
                        
                        html += `
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="font-semibold mb-2">${child.name}</div>
                                <div class="space-y-1 text-xs">
                                    <div class="flex justify-between">
                                        <span>Their Group PV:</span>
                                        <span class="font-mono">${childGroupPV.toFixed(0)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Their Group BV:</span>
                                        <span class="font-mono">${childGroupBV.toFixed(2)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Their Performance Level:</span>
                                        <span class="font-mono">${theirLevel}%</span>
                                    </div>
                                    <div class="flex justify-between text-blue-600 pt-1 border-t">
                                        <span>Differential:</span>
                                        <span class="font-mono">(${yourLevel}% - ${theirLevel}%) = ${differential}%</span>
                                    </div>
                                    <div class="flex justify-between font-bold text-green-600">
                                        <span>Bonus: ${childGroupBV.toFixed(2)} Ã— ${differential}% =</span>
                                        <span>$${diffBonus.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // Additional Income Streams
                html += `
                    <div class="border-b pb-4">
                        <h4 class="font-bold mb-3">Additional Income Streams</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Retail Margin (10% of customer sales):</span>
                                <span class="font-bold">$${income.retailMargin.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Customer Sales Incentive (up to $75):</span>
                                <span class="font-bold">$${income.customerSalesIncentive.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-green-800">Total Monthly Income:</span>
                            <span class="text-3xl font-bold text-green-600">$${income.total.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                `;
                
                return html;
            }
            
            // ============================================
            // ZOOM CONTROLS
            // ============================================
            
            zoomIn() {
                this.state.zoomLevel = Math.min(2, this.state.zoomLevel + 0.1);
                this.applyZoom();
                setTimeout(() => this.positionConnectionBars(), 100);
            }
            
            zoomOut() {
                this.state.zoomLevel = Math.max(0.2, this.state.zoomLevel - 0.1);
                this.applyZoom();
                setTimeout(() => this.positionConnectionBars(), 100);
            }
            
            autoFit() {
                const viewport = document.getElementById('org-viewport');
                const chart = document.getElementById('org-chart');
                if (!viewport || !chart) return;
                
                // Reset zoom first to measure true size
                this.state.zoomLevel = 1;
                chart.style.transform = 'scale(1)';
                
                // Wait for reflow
                requestAnimationFrame(() => {
                    const viewportWidth = viewport.clientWidth;
                    const viewportHeight = viewport.clientHeight;
                    const chartWidth = chart.scrollWidth;
                    const chartHeight = chart.scrollHeight;
                    
                    // Calculate zoom to fit both dimensions with padding
                    const padding = 40;
                    const scaleX = (viewportWidth - padding) / chartWidth;
                    const scaleY = (viewportHeight - padding) / chartHeight;
                    
                    // Use the smaller scale to ensure everything fits
                    let newZoom = Math.min(scaleX, scaleY);
                    
                    // Clamp zoom between 0.2 and 1.5
                    newZoom = Math.max(0.2, Math.min(1.5, newZoom));
                    
                    this.state.zoomLevel = newZoom;
                    this.applyZoom();
                    
                    // Center the content
                    requestAnimationFrame(() => {
                        const scaledWidth = chartWidth * newZoom;
                        const scaledHeight = chartHeight * newZoom;
                        
                        // Center horizontally
                        if (scaledWidth < viewportWidth) {
                            viewport.scrollLeft = 0;
                        } else {
                            viewport.scrollLeft = (scaledWidth - viewportWidth) / 2;
                        }
                        
                        // Scroll to top
                        viewport.scrollTop = 0;
                        
                        // Reposition connection bars after zoom
                        this.positionConnectionBars();
                    });
                });
            }
            
            applyZoom() {
                const chart = document.getElementById('org-chart');
                if (chart) {
                    chart.style.transform = `scale(${this.state.zoomLevel})`;
                    chart.style.transformOrigin = 'top center';
                }
            }
            
            // ============================================
            // ANALYTICS HELPERS
            // ============================================
            
            getVisibleMonths() {
                const allMonths = Array.from(this.state.monthlyData.keys()).sort();
                const start = this.state.timelineStartIndex;
                const end = start + this.state.timelineRange;
                return allMonths.slice(start, end);
            }
            
            getVisibleMonthsLabel() {
                const visible = this.getVisibleMonths();
                if (visible.length === 0) return 'No data';
                if (visible.length === 1) return this.formatMonthShort(visible[0]);
                return `${this.formatMonthShort(visible[0])} - ${this.formatMonthShort(visible[visible.length - 1])}`;
            }
            
            scrollTimeline(direction) {
                const allMonths = Array.from(this.state.monthlyData.keys()).sort();
                const maxStart = Math.max(0, allMonths.length - this.state.timelineRange);
                
                if (direction === 'left') {
                    this.state.timelineStartIndex = Math.max(0, this.state.timelineStartIndex - 1);
                } else {
                    this.state.timelineStartIndex = Math.min(maxStart, this.state.timelineStartIndex + 1);
                }
                
                this.renderTabContent();
            }
            
            updateTimelineRange(range) {
                this.state.timelineRange = parseInt(range);
                this.renderTabContent();
            }
            
            // ============================================
            // DATA PERSISTENCE
            // ============================================
            
            saveData() {
                try {
                    const dataToSave = {
                        version: '1.0',
                        organization: Array.from(this.state.organization.entries()),
                        monthlyData: Array.from(this.state.monthlyData.entries()).map(([month, data]) => [
                            month,
                            {
                                organization: Array.from(data.organization ? data.organization.entries() : []),
                                income: data.income,
                                timestamp: data.timestamp
                            }
                        ]),
                        selectedNode: this.state.selectedNode,
                        currentMonth: this.state.currentMonth,
                        savedVersions: this.state.savedVersions, // Include saved versions
                        lastSaved: new Date().toISOString()
                    };
                    
                    localStorage.setItem('amwayBusinessPlanner', JSON.stringify(dataToSave));
                    console.log('Data saved successfully');
                } catch (error) {
                    console.error('Error saving data:', error);
                    alert('Error saving data. Your browser storage may be full.');
                }
            }
            
            loadSavedData() {
                try {
                    // First, load any embedded versions from the HTML file
                    this.loadEmbeddedVersions();
                    
                    const saved = localStorage.getItem('amwayBusinessPlanner');
                    if (!saved) return;
                    
                    const data = JSON.parse(saved);
                    
                    if (data.organization) {
                        this.state.organization = new Map(data.organization);
                    }
                    
                    // Load saved versions from localStorage (merge with embedded)
                    if (data.savedVersions && Array.isArray(data.savedVersions)) {
                        const existingIds = new Set(this.state.savedVersions.map(v => v.id));
                        const newVersions = data.savedVersions.filter(v => !existingIds.has(v.id));
                        this.state.savedVersions = [...this.state.savedVersions, ...newVersions];
                    }
                    
                    if (data.monthlyData) {
                        this.state.monthlyData = new Map(
                            data.monthlyData.map(([month, monthData]) => [
                                month,
                                {
                                    organization: new Map(monthData.organization),
                                    income: monthData.income,
                                    timestamp: monthData.timestamp
                                }
                            ])
                        );
                    }
                    
                    if (data.selectedNode) {
                        this.state.selectedNode = data.selectedNode;
                    }
                    
                    if (data.currentMonth) {
                        this.state.currentMonth = data.currentMonth;
                    }
                    
                    console.log('Data loaded successfully');
                } catch (error) {
                    console.error('Error loading saved data:', error);
                }
            }
            
            // ============================================
            // VERSION MANAGEMENT SYSTEM
            // ============================================
            
            /**
             * Save current state as a new version
             */
            saveVersion(customName = null) {
                const versionName = customName || prompt('Enter a name for this version:', `Version ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`);
                
                if (!versionName) return; // User cancelled
                
                const income = this.calculateIncome();
                const version = {
                    id: Date.now(),
                    name: versionName,
                    timestamp: new Date().toISOString(),
                    organization: Array.from(this.state.organization.entries()),
                    monthlyData: Array.from(this.state.monthlyData.entries()).map(([month, data]) => [
                        month,
                        {
                            organization: Array.from(data.organization ? data.organization.entries() : []),
                            income: data.income,
                            timestamp: data.timestamp
                        }
                    ]),
                    currentMonth: this.state.currentMonth,
                    summary: {
                        totalMembers: this.state.organization.size,
                        totalPV: income.totalPV,
                        totalIncome: income.total,
                        qualifiedLegs: income.qualifiedLegs
                    }
                };
                
                this.state.savedVersions.push(version);
                this.saveData(); // Save to localStorage
                
                alert(`Version "${versionName}" saved successfully!\n\nClick "Versions" to view all saved versions or download an HTML file with all versions embedded.`);
            }
            
            /**
             * Load a specific version
             */
            loadVersion(versionId) {
                const version = this.state.savedVersions.find(v => v.id === versionId);
                if (!version) {
                    alert('Version not found');
                    return;
                }
                
                if (!confirm(`Load version "${version.name}"?\n\nThis will replace your current organization structure. Make sure to save your current work first if needed.`)) {
                    return;
                }
                
                try {
                    this.state.organization = new Map(version.organization);
                    
                    if (version.monthlyData) {
                        this.state.monthlyData = new Map(
                            version.monthlyData.map(([month, monthData]) => [
                                month,
                                {
                                    organization: new Map(monthData.organization || []),
                                    income: monthData.income,
                                    timestamp: monthData.timestamp
                                }
                            ])
                        );
                    }
                    
                    if (version.currentMonth) {
                        this.state.currentMonth = version.currentMonth;
                    }
                    
                    this.state.selectedNode = null;
                    this.state.incomePerspectiveNode = 'root';
                    
                    this.render();
                    this.closeVersionManager();
                    
                    alert(`Version "${version.name}" loaded successfully!`);
                } catch (error) {
                    console.error('Error loading version:', error);
                    alert('Error loading version. The data may be corrupted.');
                }
            }
            
            /**
             * Delete a specific version
             */
            deleteVersion(versionId) {
                const version = this.state.savedVersions.find(v => v.id === versionId);
                if (!version) return;
                
                if (!confirm(`Delete version "${version.name}"?\n\nThis cannot be undone.`)) {
                    return;
                }
                
                this.state.savedVersions = this.state.savedVersions.filter(v => v.id !== versionId);
                this.saveData();
                this.showVersionManager(); // Refresh the modal
            }
            
            /**
             * Show version manager modal
             */
            showVersionManager() {
                // Load any embedded versions first
                this.loadEmbeddedVersions();
                
                const versions = this.state.savedVersions;
                
                let versionsHtml = '';
                if (versions.length === 0) {
                    versionsHtml = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-folder-open text-4xl mb-4"></i>
                            <p>No saved versions yet.</p>
                            <p class="text-sm mt-2">Click "Save Version" to create your first version.</p>
                        </div>
                    `;
                } else {
                    versionsHtml = versions.map(v => {
                        const date = new Date(v.timestamp);
                        return `
                            <div class="border rounded-lg p-4 mb-3 hover:bg-gray-50 transition-colors">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h4 class="font-bold text-gray-800">${v.name}</h4>
                                        <p class="text-sm text-gray-500">${date.toLocaleDateString()} at ${date.toLocaleTimeString()}</p>
                                        <div class="text-xs text-gray-400 mt-1">
                                            <span class="mr-3"><i class="fas fa-users mr-1"></i>${v.summary?.totalMembers || '?'} members</span>
                                            <span class="mr-3"><i class="fas fa-chart-line mr-1"></i>${(v.summary?.totalPV || 0).toLocaleString()} PV</span>
                                            <span><i class="fas fa-dollar-sign mr-1"></i>$${(v.summary?.totalIncome || 0).toFixed(2)}</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 ml-4">
                                        <button onclick="app.loadVersion(${v.id})" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                                            <i class="fas fa-upload mr-1"></i>Load
                                        </button>
                                        <button onclick="app.deleteVersion(${v.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                            <i class="fas fa-trash mr-1"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                const modal = document.createElement('div');
                modal.id = 'version-manager-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col">
                        <div class="p-6 border-b flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800">
                                <i class="fas fa-history mr-2 text-indigo-600"></i>Version Manager
                            </h2>
                            <button onclick="app.closeVersionManager()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="p-6 overflow-y-auto flex-1">
                            <div class="mb-4 p-4 bg-blue-50 rounded-lg text-sm text-blue-700">
                                <i class="fas fa-info-circle mr-2"></i>
                                Versions are stored in your browser and embedded in downloaded HTML files. 
                                Share the HTML file to share all your versions with others.
                            </div>
                            
                            ${versionsHtml}
                        </div>
                        
                        <div class="p-6 border-t bg-gray-50 rounded-b-xl">
                            <div class="flex flex-wrap gap-3 justify-between">
                                <button onclick="app.saveVersion()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    <i class="fas fa-plus mr-2"></i>Save New Version
                                </button>
                                <button onclick="app.downloadVersionedHTML()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                    <i class="fas fa-download mr-2"></i>Download HTML with All Versions
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                modal.onclick = (e) => {
                    if (e.target === modal) this.closeVersionManager();
                };
            }
            
            /**
             * Close version manager modal
             */
            closeVersionManager() {
                const modal = document.getElementById('version-manager-modal');
                if (modal) modal.remove();
            }
            
            /**
             * Load versions embedded in the HTML file itself
             */
            loadEmbeddedVersions() {
                const embeddedData = document.getElementById('embedded-versions-data');
                if (embeddedData) {
                    try {
                        const data = JSON.parse(embeddedData.textContent);
                        if (data.versions && Array.isArray(data.versions)) {
                            // Merge embedded versions with existing ones (avoid duplicates by ID)
                            const existingIds = new Set(this.state.savedVersions.map(v => v.id));
                            const newVersions = data.versions.filter(v => !existingIds.has(v.id));
                            this.state.savedVersions = [...this.state.savedVersions, ...newVersions];
                        }
                    } catch (e) {
                        console.log('No embedded versions found or invalid format');
                    }
                }
            }
            
            /**
             * Download the entire HTML file with all versions embedded
             */
            downloadVersionedHTML() {
                // First, save current state as a version if there are changes
                const shouldSaveCurrent = confirm('Would you like to save your current work as a new version before downloading?');
                if (shouldSaveCurrent) {
                    this.saveVersion();
                }
                
                // Get the current HTML document
                const html = document.documentElement.outerHTML;
                
                // Create the versions data to embed
                const versionsData = JSON.stringify({
                    versions: this.state.savedVersions,
                    lastExport: new Date().toISOString()
                });
                
                // Check if embedded data script already exists
                let modifiedHtml = html;
                // Use string concatenation to avoid browser parsing these as actual tags
                const scriptEnd = '<' + '/script>';
                const headEnd = '<' + '/head>';
                const existingDataPattern = new RegExp('<script id="embedded-versions-data" type="application/json">[\\s\\S]*?' + scriptEnd);
                const newDataScript = '<script id="embedded-versions-data" type="application/json">' + versionsData + scriptEnd;
                
                if (existingDataPattern.test(modifiedHtml)) {
                    // Replace existing
                    modifiedHtml = modifiedHtml.replace(existingDataPattern, newDataScript);
                } else {
                    // Add before closing head tag
                    modifiedHtml = modifiedHtml.replace(headEnd, newDataScript + '\n' + headEnd);
                }
                
                // Create and download the file
                const doctype = '<' + '!DOCTYPE html>\n';
                const blob = new Blob([doctype + modifiedHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Amway-Business-Planner-' + new Date().toISOString().split('T')[0] + '.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('HTML file downloaded with ' + this.state.savedVersions.length + ' version(s) embedded.\n\nWhen you or anyone else opens this file, all saved versions will be available in the Version Manager.');
            }
            
            // ============================================
            // UTILITY METHODS
            // ============================================
            
            // Theme Methods
            loadThemePreference() {
                // Check localStorage first
                const savedTheme = localStorage.getItem('amwayPlannerTheme');
                if (savedTheme) {
                    this.state.darkMode = savedTheme === 'dark';
                } else {
                    // Check system preference
                    this.state.darkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                }
                this.applyTheme();
            }
            
            toggleTheme() {
                this.state.darkMode = !this.state.darkMode;
                localStorage.setItem('amwayPlannerTheme', this.state.darkMode ? 'dark' : 'light');
                this.applyTheme();
                this.render(); // Re-render to update icon
            }
            
            applyTheme() {
                if (this.state.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.documentElement.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.documentElement.classList.remove('dark-mode');
                }
            }
            
            generateMonthOptions() {
                const options = [];
                const today = new Date();
                
                // Generate 12 months back and 12 months forward
                for (let i = -12; i <= 12; i++) {
                    const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                    const monthStr = date.toISOString().slice(0, 7);
                    const selected = monthStr === this.state.currentMonth ? 'selected' : '';
                    options.push(`<option value="${monthStr}" ${selected}>${this.formatMonth(monthStr)}</option>`);
                }
                
                return options.join('');
            }
            
            changeMonth(monthStr) {
                this.state.currentMonth = monthStr;
                this.saveData();
            }
            
            formatMonth(monthStr) {
                const [year, month] = monthStr.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }
            
            formatMonthShort(monthStr) {
                const [year, month] = monthStr.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }
            
            formatKey(key) {
                return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            }
            
            getMonthsSince(date) {
                const now = new Date();
                return (now.getFullYear() - date.getFullYear()) * 12 + (now.getMonth() - date.getMonth());
            }
        }
        
        // ============================================
        // EXPORT MANAGER CLASS
        // ============================================
        
        class ExportManager {
            constructor(planner) {
                this.planner = planner;
            }
            
            async exportToPDF() {
                // Check for required libraries
                if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                    alert('PDF export libraries are not loaded. Please check your internet connection and refresh the page.');
                    return;
                }
                
                alert('Generating PDF... This may take a moment.');
                
                try {
                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) {
                        throw new Error('jsPDF not available');
                    }
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    // Cover Page
                    pdf.setFontSize(24);
                    pdf.text('Amway Business Plan', 105, 40, { align: 'center' });
                    pdf.setFontSize(14);
                    pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 50, { align: 'center' });
                    
                    // Organization Chart
                    pdf.addPage();
                    pdf.setFontSize(18);
                    pdf.text('Organization Structure', 20, 20);
                    
                    const chartElement = document.getElementById('org-chart');
                    if (chartElement) {
                        const canvas = await html2canvas(chartElement, {
                            scale: 2,
                            logging: false,
                            backgroundColor: '#ffffff'
                        });
                        
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = 170;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        pdf.addImage(imgData, 'PNG', 20, 30, imgWidth, Math.min(imgHeight, 250));
                    }
                    
                    // Income Summary
                    pdf.addPage();
                    pdf.setFontSize(18);
                    pdf.text('Income Summary', 20, 20);
                    
                    const income = this.planner.calculateIncome();
                    let yPos = 40;
                    
                    pdf.setFontSize(12);
                    pdf.text(`Performance Bonus: $${income.performanceBonus.toFixed(2)}`, 20, yPos);
                    yPos += 10;
                    pdf.text(`Differential Bonus: $${income.differentialBonus.toFixed(2)}`, 20, yPos);
                    yPos += 10;
                    pdf.text(`Retail Margin: $${income.retailMargin.toFixed(2)}`, 20, yPos);
                    yPos += 10;
                    pdf.text(`Customer Sales Incentive: $${income.customerSalesIncentive.toFixed(2)}`, 20, yPos);
                    yPos += 15;
                    
                    pdf.setFontSize(14);
                    pdf.text(`Total Monthly Income: $${income.total.toFixed(2)}`, 20, yPos);
                    
                    // Disclaimers
                    pdf.addPage();
                    pdf.setFontSize(10);
                    pdf.text('Important Disclaimers:', 20, 20);
                    yPos = 30;
                    
                    const disclaimers = [
                        'For the calendar year 2024, the average income from Amway for all U.S. registered',
                        'IBOs at the Founders Platinum level and below was approximately $900 before expenses.',
                        '',
                        'Earnings depend on many factors, including customer base, business experience,',
                        'effort, dedication, and quality and performance of the downline sales team.',
                        '',
                        'This calculator provides estimates based on 2025 compensation plan data and',
                        'should be used for planning purposes only.'
                    ];
                    
                    disclaimers.forEach(line => {
                        pdf.text(line, 20, yPos);
                        yPos += 5;
                    });
                    
                    pdf.save(`Amway_Business_Plan_${new Date().toISOString().slice(0, 10)}.pdf`);
                    alert('PDF exported successfully!');
                } catch (error) {
                    console.error('Error exporting PDF:', error);
                    alert('Error exporting PDF. Please try again.');
                }
            }
            
            async exportToImage() {
                // Check for required library
                if (typeof html2canvas === 'undefined') {
                    alert('Image export library is not loaded. Please check your internet connection and refresh the page.');
                    return;
                }
                
                alert('Generating image... This may take a moment.');
                
                try {
                    const chartElement = document.getElementById('org-chart');
                    if (!chartElement) {
                        alert('No organization chart to export');
                        return;
                    }
                    
                    const canvas = await html2canvas(chartElement, {
                        scale: 3,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });
                    
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Amway_Org_Chart_${new Date().toISOString().slice(0, 10)}.png`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Image exported successfully!');
                    });
                } catch (error) {
                    console.error('Error exporting image:', error);
                    alert('Error exporting image. Please try again.');
                }
            }
            
            // Export all data to JSON file for backup
            exportToJSON() {
                try {
                    const dataToExport = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        appName: 'Amway Business Planner 2025',
                        organization: Array.from(this.planner.state.organization.entries()),
                        monthlyData: Array.from(this.planner.state.monthlyData.entries()).map(([month, data]) => [
                            month,
                            {
                                organization: Array.from(data.organization.entries()),
                                income: data.income,
                                timestamp: data.timestamp
                            }
                        ]),
                        currentMonth: this.planner.state.currentMonth
                    };
                    
                    const jsonString = JSON.stringify(dataToExport, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Amway_Backup_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert('Backup exported successfully! Keep this file safe to restore your data later.');
                } catch (error) {
                    console.error('Error exporting backup:', error);
                    alert('Error creating backup. Please try again.');
                }
            }
            
            // Trigger file input for import
            triggerImport() {
                const fileInput = document.getElementById('import-file-input');
                if (fileInput) {
                    fileInput.click();
                }
            }
            
            // Import data from JSON file
            importFromJSON(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate the data structure
                        if (!data.organization || !data.version) {
                            throw new Error('Invalid backup file format');
                        }
                        
                        // Confirm before overwriting
                        if (!confirm(`This will replace all your current data with the backup from ${data.exportDate ? new Date(data.exportDate).toLocaleDateString() : 'unknown date'}. Continue?`)) {
                            return;
                        }
                        
                        // Restore organization
                        this.planner.state.organization = new Map(data.organization);
                        
                        // Restore monthly data
                        if (data.monthlyData) {
                            this.planner.state.monthlyData = new Map(
                                data.monthlyData.map(([month, monthData]) => [
                                    month,
                                    {
                                        organization: new Map(monthData.organization),
                                        income: monthData.income,
                                        timestamp: monthData.timestamp
                                    }
                                ])
                            );
                        }
                        
                        // Restore current month
                        if (data.currentMonth) {
                            this.planner.state.currentMonth = data.currentMonth;
                        }
                        
                        // Save and refresh
                        this.planner.saveData();
                        this.planner.render();
                        
                        alert('Backup restored successfully!');
                    } catch (error) {
                        console.error('Error importing backup:', error);
                        alert('Error restoring backup. Please make sure you selected a valid backup file.');
                    }
                };
                
                reader.readAsText(file);
                
                // Reset the file input so the same file can be selected again
                event.target.value = '';
            }
        }
        
        // ============================================
        // INITIALIZE APPLICATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AmwayBusinessPlanner();
            window.app.exportManager = new ExportManager(window.app);
        });
    </script>
</body>
</html>
