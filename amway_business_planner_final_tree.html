<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amway Business Planner - Hierarchical Tree Edition</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; }
        .header { background-color: #0033a0; color: white; padding: 1rem; text-align: center; }
        .nav-tabs .nav-link.active { background-color: #0033a0; color: white; }
        #organization-chart {
            overflow-x: auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            margin-top: 20px;
            min-height: 500px;
        }

        /* Organization Chart Styles */
        #organization-chart {
            position: relative;
            min-height: 600px;
            overflow: auto;
        }
        .org-node {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 4px solid white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .org-node .name { font-weight: bold; }
        .org-node .pv { font-size: 0.9em; }
        .org-node .vcs-indicator { font-size: 1.2em; }

        .connection-line {
            position: absolute;
            background-color: #ccc;
            z-index: -1;
        }

    </style>
</head>
<body>

    <div class="header">
        <h1>Amway Business Planner</h1>
    </div>

    <div class="container-fluid mt-4">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="builder-tab" data-toggle="tab" href="#builder" role="tab">Visual Builder</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="multi-month-tab" data-toggle="tab" href="#multi-month" role="tab">Multi-Month Planning</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="reports-tab" data-toggle="tab" href="#reports" role="tab">Reports</a>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="builder" role="tabpanel">
                <div id="organization-chart"></div>
            </div>
            <div class="tab-pane fade" id="multi-month" role="tabpanel">
                <div class="p-4">
                    <h3>Multi-Month Income & Growth Projection</h3>
                    <p>Plan your business growth over time. Set a monthly growth rate to see how your income evolves.</p>
                    <div class="form-row align-items-center">
                        <div class="col-auto">
                            <label for="growthRateInput">Monthly PV Growth Rate (%)</label>
                            <input type="number" class="form-control mb-2" id="growthRateInput" value="5">
                        </div>
                        <div class="col-auto">
                            <label for="monthsInput">Projection (Months)</label>
                            <input type="number" class="form-control mb-2" id="monthsInput" value="12">
                        </div>
                        <div class="col-auto">
                             <button id="calculateProjectionBtn" class="btn btn-primary mt-4">Calculate</button>
                        </div>
                    </div>
                    <div id="projection-table" class="mt-4"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <div class="p-4">
                    <h3>Business Reports</h3>
                    <p>A real-time overview of your organization's key metrics.</p>
                    <div id="reports-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit IBO Modal -->
    <div class="modal fade" id="editIboModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Edit IBO</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="iboIdInput">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" class="form-control" id="nameInput" placeholder="IBO Name">
                    </div>
                    <div class="form-group">
                        <label>Personal PV</label>
                        <small class="form-text text-muted">Editing PV will auto-calculate BV (1 PV = 3.43 BV)</small>
                        <input type="number" class="form-control" id="pvInput" placeholder="e.g., 150">
                    </div>
                    <div class="form-group">
                        <label>Personal BV</label>
                         <input type="number" class="form-control" id="bvInput" placeholder="e.g., 514.5">
                    </div>
                    <div class="form-group">
                        <label>VCS Compliance %</label>
                        <input type="number" class="form-control" id="vcsInput" placeholder="e.g., 70">
                    </div>
                     <button id="setCompliantBtn" class="btn btn-info btn-sm">Set Compliant (70%)</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveIboBtn">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PV_TO_BV_RATIO = 3.43;

        let iboData = [{
            id: 1,
            name: "You",
            pv: 300,
            bv: 1029,
            vcsPercentage: 100,
            children: []
        }];

        function findIboById(id, node = iboData[0]) {
            if (node.id === id) return node;
            for (const child of node.children) {
                const found = findIboById(id, child);
                if (found) return found;
            }
            return null;
        }

        function findParentOf(id, node = iboData[0]) {
            for (const child of node.children) {
                if (child.id === id) return node;
                const found = findParentOf(id, child);
                if (found) return found;
            }
            return null;
        }

        function createNodeElement(ibo) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'org-node';
            nodeDiv.dataset.id = ibo.id;

            const vcsIndicator = ibo.vcsPercentage >= 70 ? '‚úÖ' : '‚ùå';

            nodeDiv.innerHTML = `
                <div class="name">${ibo.name}</div>
                <div class="pv">${ibo.pv} PV</div>
                <div class="vcs-indicator">${vcsIndicator}</div>
                <div class="node-actions" style="position: absolute; top: -10px; right: -10px; display: flex; gap: 5px;">
                     <button class="btn btn-sm btn-success add-downline-btn" title="Add IBO" style="border-radius: 50%; width: 24px; height: 24px;">+</button>
                     <button class="btn btn-sm btn-primary edit-ibo-btn" title="Edit IBO" style="border-radius: 50%; width: 24px; height: 24px;">E</button>
                    ${ibo.id !== 1 ? `<button class="btn btn-sm btn-danger remove-ibo-btn" title="Remove IBO" style="border-radius: 50%; width: 24px; height: 24px;">X</button>` : ''}
                </div>
            `;

            // Attach events directly to the buttons inside the node
            nodeDiv.querySelector('.add-downline-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showEditIboModal(null, ibo.id);
            });
            nodeDiv.querySelector('.edit-ibo-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showEditIboModal(ibo.id);
            });
            if (ibo.id !== 1) {
                nodeDiv.querySelector('.remove-ibo-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if(confirm('Are you sure you want to remove this IBO and their entire downline?')) {
                        removeIbo(ibo.id);
                    }
                });
            }

            return nodeDiv;
        }

        function renderOrganization() {
            const chartContainer = document.getElementById('organization-chart');
            chartContainer.innerHTML = ''; // Clear previous render

            const positions = {};
            const nodeWidth = 140; // Includes margin
            const levelHeight = 160;

            function calculatePositions(ibo, level = 0, startX = 0) {
                const children = ibo.children || [];
                let childrenWidth = 0;
                let childStartX = startX;
                const siblingGap = 40; // Add a gap between sibling branches

                // Recursively calculate positions for children first
                for (const child of children) {
                    const childWidth = calculatePositions(child, level + 1, childStartX);
                    childrenWidth += childWidth + siblingGap;
                    childStartX += childWidth + siblingGap;
                }
                if (children.length > 0) {
                    childrenWidth -= siblingGap; // Remove last gap
                }

                // Position the parent in the middle of its children
                let x;
                if (children.length > 0) {
                    const firstChildPos = positions[children[0].id];
                    const lastChildPos = positions[children[children.length - 1].id];
                    x = (firstChildPos.x + lastChildPos.x) / 2;
                } else {
                    x = startX;
                }

                positions[ibo.id] = { x: x, y: level * levelHeight };

                // Return the total width of this branch
                return Math.max(nodeWidth, childrenWidth);
            }

            const totalWidth = calculatePositions(iboData[0]);

            // Normalize and center the tree
            let minX = Infinity;
            for(const id in positions) {
                minX = Math.min(minX, positions[id].x);
            }
            const chartWidth = chartContainer.clientWidth;
            const shiftX = (chartWidth / 2) - (totalWidth / 2) - minX;

            // Create and position nodes
            for (const iboId in positions) {
                const ibo = findIboById(parseInt(iboId));
                if (ibo) {
                    const pos = positions[iboId];
                    const nodeEl = createNodeElement(ibo);
                    nodeEl.style.left = `${pos.x + shiftX}px`;
                    nodeEl.style.top = `${pos.y}px`;
                    chartContainer.appendChild(nodeEl);

                    // Draw line to parent
                    const parent = findParentOf(ibo.id);
                    if (parent && positions[parent.id]) {
                        const parentPos = positions[parent.id];
                        const line = document.createElement('div');
                        line.className = 'connection-line';
                        const dx = pos.x - parentPos.x;
                        const dy = pos.y - parentPos.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                        line.style.width = `${distance}px`;
                        line.style.height = '2px';
                        line.style.transform = `rotate(${angle}deg)`;
                        line.style.transformOrigin = '0 0';
                        line.style.left = `${parentPos.x + 60 + shiftX}px`;
                        line.style.top = `${parentPos.y + 60}px`;
                        chartContainer.appendChild(line);
                    }
                }
            }
        }

        function showEditIboModal(iboId, parentId = null) {
            const isNew = !iboId;
            if (isNew) {
                document.getElementById('modalTitle').innerText = 'Add New IBO';
                document.getElementById('iboIdInput').value = `new_${parentId}`;
                document.getElementById('nameInput').value = '';
                // Set default values for new IBO
                document.getElementById('pvInput').value = 150;
                document.getElementById('bvInput').value = 150 * PV_TO_BV_RATIO;
                document.getElementById('vcsInput').value = 70; // Default to compliant
            } else {
                const ibo = findIboById(iboId);
                document.getElementById('modalTitle').innerText = `Edit ${ibo.name}`;
                document.getElementById('iboIdInput').value = ibo.id;
                document.getElementById('nameInput').value = ibo.name;
                document.getElementById('pvInput').value = ibo.pv;
                document.getElementById('bvInput').value = ibo.bv;
                document.getElementById('vcsInput').value = ibo.vcsPercentage;
            }
            $('#editIboModal').modal('show');
        }

        function saveIboData() {
            const iboIdRaw = document.getElementById('iboIdInput').value;
            const name = document.getElementById('nameInput').value;
            const pv = parseFloat(document.getElementById('pvInput').value) || 0;
            const bv = parseFloat(document.getElementById('bvInput').value) || 0;
            const vcsPercentage = parseFloat(document.getElementById('vcsInput').value) || 0;

            if (!name) {
                alert('IBO Name is required.');
                return;
            }

            if (iboIdRaw.startsWith('new_')) {
                const parentId = parseInt(iboIdRaw.split('_')[1]);
                const parent = findIboById(parentId);
                const newIbo = {
                    id: Date.now(),
                    name,
                    pv,
                    bv,
                    vcsPercentage,
                    children: []
                };
                parent.children.push(newIbo);
            } else {
                const ibo = findIboById(parseInt(iboIdRaw));
                ibo.name = name;
                ibo.pv = pv;
                ibo.bv = bv;
                ibo.vcsPercentage = vcsPercentage;
            }

            $('#editIboModal').modal('hide');
            renderAll();
        }

        function removeIbo(iboId) {
            const parent = findParentOf(iboId);
            if(parent) {
                parent.children = parent.children.filter(child => child.id !== iboId);
                renderAll();
            } else {
                alert("Cannot remove the root IBO.");
            }
        }

        function renderAll() {
            renderOrganization();
            renderReports();
            renderProjection();
        }

        // --- Reports Tab Logic ---
        function getTotalPV(node = iboData[0]) {
            let total = node.pv;
            for (const child of node.children) {
                total += getTotalPV(child);
            }
            return total;
        }

        function getTeamSize(node = iboData[0]) {
            let size = 1;
            for (const child of node.children) {
                size += getTeamSize(child);
            }
            return size;
        }

        function renderReports() {
            const reportsContainer = document.getElementById('reports-content');
            const totalPV = getTotalPV();
            const teamSize = getTeamSize();
            // NOTE: A full income calculation is very complex. This is a simplified placeholder.
            const estimatedIncome = totalPV * 0.1;

            reportsContainer.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Total Group PV</h5>
                                <p class="card-text">${totalPV.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Team Size</h5>
                                <p class="card-text">${teamSize}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Estimated Monthly Income</h5>
                                <p class="card-text">$${estimatedIncome.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Multi-Month Projection Logic ---
        function renderProjection() {
            const projectionContainer = document.getElementById('projection-table');
            const growthRate = parseFloat(document.getElementById('growthRateInput').value) / 100;
            const months = parseInt(document.getElementById('monthsInput').value);
            const initialPV = getTotalPV();

            let tableHTML = '<table class="table table-striped"><thead><tr><th>Month</th><th>Projected PV</th><th>Estimated Income</th></tr></thead><tbody>';
            let currentPV = initialPV;

            for (let i = 1; i <= months; i++) {
                currentPV *= (1 + growthRate);
                let estimatedIncome = currentPV * 0.1; // Simplified income
                tableHTML += `<tr><td>${i}</td><td>${currentPV.toFixed(2)}</td><td>$${estimatedIncome.toFixed(2)}</td></tr>`;
            }

            tableHTML += '</tbody></table>';
            projectionContainer.innerHTML = tableHTML;
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderAll();
            document.getElementById('saveIboBtn').addEventListener('click', saveIboData);
            document.getElementById('calculateProjectionBtn').addEventListener('click', renderProjection);

            // Auto-calculate BV from PV
            document.getElementById('pvInput').addEventListener('input', (e) => {
                const pv = parseFloat(e.target.value) || 0;
                document.getElementById('bvInput').value = (pv * PV_TO_BV_RATIO).toFixed(2);
            });

            // Set compliant button
            document.getElementById('setCompliantBtn').addEventListener('click', () => {
                document.getElementById('vcsInput').value = 70;
            });
        });

        console.log('üöÄ Amway Ultimate Business Planner 2024 - HIERARCHICAL TREE EDITION with NO OVERLAPPING!');
    </script>
</body>
</html>
